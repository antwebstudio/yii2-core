!function(e){"undefined"==typeof Ant&&(Ant={}),e.extend(Ant,{left:"left",right:"right",getCsrfInput:function(){return Ant.csrfTokenName?'<input type="hidden" name="'+Ant.csrfTokenName+'" value="'+Ant.csrfTokenValue+'"/>':""},postActionRequest:function(t,s,i,n){"function"==typeof s&&(n=i,i=s,s={}),Ant.csrfTokenValue&&Ant.csrfTokenName&&("string"==typeof s?(s&&(s+="&"),s+=Ant.csrfTokenName+"="+Ant.csrfTokenValue):("object"!=typeof s&&(s={}),s[Ant.csrfTokenName]=Ant.csrfTokenValue));var r=e.ajax(e.extend({url:Ant.getActionUrl(t),type:"POST",data:s,success:i,error:function(e,t){i&&i(null,t,e)},complete:function(e,t){"success"!=t&&("undefined"!=typeof Ant.cp?Ant.cp.displayError():alert(Ant.t("An unknown error occurred.")))}},n));return n&&"function"==typeof n.send&&n.send(r),r},_waitingOnAjax:!1,_ajaxQueue:[],queueActionRequest:function(e,t,s,i){"function"==typeof t&&(i=s,s=t,t=void 0),Ant._ajaxQueue.push([e,t,s,i]),Ant._waitingOnAjax||Ant._postNextActionRequestInQueue()},_postNextActionRequestInQueue:function(){Ant._waitingOnAjax=!0;var e=Ant._ajaxQueue.shift();Ant.postActionRequest(e[0],e[1],function(t,s,i){e[2]&&"function"==typeof e[2]&&e[2](t,s,i),Ant._ajaxQueue.length?Ant._postNextActionRequestInQueue():Ant._waitingOnAjax=!1},e[3])},compare:function(e,t){if(typeof e!=typeof t)return!1;if("object"==typeof e){if(e.length!=t.length)return!1;if(e instanceof Array!=t instanceof Array)return!1;if(!(e instanceof Array||Ant.compare(Ant.getObjectKeys(e),Ant.getObjectKeys(t))))return!1;for(var s in e)if(!Ant.compare(e[s],t[s]))return!1;return!0}return e===t},getObjectKeys:function(e){var t=[];for(var s in e)t.push(s);return t},escapeChars:function(e){Helper.isArray(e)||(e=e.split());for(var t="",s=0;s<e.length;s++)t+="\\"+e[s];return t},ltrim:function(e,t){if(!e)return e;void 0===t&&(t=" 	\n\r\x00");var s=new RegExp("^["+Ant.escapeChars(t)+"]+");return e.replace(s,"")},rtrim:function(e,t){if(!e)return e;void 0===t&&(t=" 	\n\r\x00");var s=new RegExp("["+Ant.escapeChars(t)+"]+$");return e.replace(s,"")},trim:function(e,t){return e=Ant.ltrim(e,t),e=Ant.rtrim(e,t)},filterArray:function(e,t){for(var s=[],i=0;i<e.length;i++){if("function"==typeof t)var n=t(e[i],i);else var n=e[i];n&&s.push(e[i])}return s},inArray:function(t,s){return-1!=e.inArray(t,s)},removeFromArray:function(t,s){var i=e.inArray(t,s);return-1!=i?(s.splice(i,1),!0):!1},getLast:function(e){return e.length?e[e.length-1]:null},uppercaseFirst:function(e){return e.charAt(0).toUpperCase()+e.slice(1)},lowercaseFirst:function(e){return e.charAt(0).toLowerCase()+e.slice(1)},secondsToHumanTimeDuration:function(e,t){"undefined"==typeof t&&(t=!0);var s=604800,i=86400,n=3600,r=60,a=Math.floor(e/s);e%=s;var l=Math.floor(e/i);e%=i;var o=Math.floor(e/n);if(e%=n,t){var d=Math.floor(e/r);e%=r}else{var d=Math.round(e/r);e=0}return timeComponents=[],a&&timeComponents.push(a+" "+Ant.t(1==a?"week":"weeks")),l&&timeComponents.push(l+" "+Ant.t(1==l?"day":"days")),o&&timeComponents.push(o+" "+Ant.t(1==o?"hour":"hours")),!d&&(t||a||l||o)||timeComponents.push(d+" "+Ant.t(1==d?"minute":"minutes")),(e||t&&!a&&!l&&!o&&!d)&&timeComponents.push(e+" "+Ant.t(1==e?"second":"seconds")),timeComponents.join(", ")},asciiString:function(e){for(var t="",s=0;s<e.length;s++){var i=e.charCodeAt(s);i>=32&&128>i?t+=e.charAt(s):"undefined"!=typeof Ant.asciiCharMap[i]&&(t+=Ant.asciiCharMap[i])}return t},preventOutlineOnMouseFocus:function(t){var s=e(t),i=".preventOutlineOnMouseFocus";s.on("mousedown"+i,function(){s.addClass("no-outline"),s.focus()}).on("keydown"+i+" blur"+i,function(e){e.keyCode!=Helper.SHIFT_KEY&&e.keyCode!=Helper.CTRL_KEY&&e.keyCode!=Helper.CMD_KEY&&s.removeClass("no-outline")})},createErrorList:function(t){for(var s=e(document.createElement("ul")).addClass("errors"),i=0;i<t.length;i++){var n=e(document.createElement("li"));n.appendTo(s),n.html(t[i])}return s},initUiElements:function(t){e(".grid",t).grid(),e(".pane",t).pane(),e(".info",t).infoicon(),e(".checkbox-select",t).checkboxselect(),e(".fieldtoggle",t).fieldtoggle(),e(".lightswitch",t).lightswitch(),e(".nicetext",t).nicetext(),e(".pill",t).pill(),e(".formsubmit",t).formsubmit(),e(".menubtn",t).menubtn()},_elementIndexClasses:{},_elementSelectorModalClasses:{},registerElementIndexClass:function(e,t){if("undefined"!=typeof this._elementIndexClasses[e])throw"An element index class has already been registered for the element type “"+e+"”.";this._elementIndexClasses[e]=t},registerElementSelectorModalClass:function(e,t){if("undefined"!=typeof this._elementSelectorModalClasses[e])throw"An element selector modal class has already been registered for the element type “"+e+"”.";this._elementSelectorModalClasses[e]=t},createElementIndex:function(e,t,s){if("undefined"!=typeof this._elementIndexClasses[e])var i=this._elementIndexClasses[e];else var i=Ant.BaseElementIndex;return new i(e,t,s)},createElementSelectorModal:function(e,t){if("undefined"!=typeof this._elementSelectorModalClasses[e])var s=this._elementSelectorModalClasses[e];else var s=Ant.BaseElementSelectorModal;return new s(e,t)},getLocalStorage:function(e,t){return e="Ant-"+Ant.siteUid+"."+e,"undefined"!=typeof localStorage&&"undefined"!=typeof localStorage[e]?JSON.parse(localStorage[e]):t},setLocalStorage:function(e,t){if("undefined"!=typeof localStorage){e="Ant-"+Ant.siteUid+"."+e;try{localStorage[e]=JSON.stringify(t)}catch(s){}}},getElementInfo:function(t){var s=e(t);s.hasClass("element")||(s=s.find(".element:first"));var i={id:s.data("id"),locale:s.data("locale"),label:s.data("label"),status:s.data("status"),url:s.data("url"),hasThumb:s.hasClass("hasthumb"),$element:s};return i},showElementEditor:function(e){!Helper.hasAttr(e,"data-editable")||e.hasClass("disabled")||e.hasClass("loading")||new Ant.ElementEditor(e)}}),Ant.BaseElementIndex=Helper.Base.extend({initialized:!1,elementType:null,instanceState:null,sourceStates:null,sourceStatesStorageKey:null,searchTimeout:null,elementSelect:null,sourceSelect:null,structureTableSort:null,isIndexBusy:!1,selectable:!1,multiSelect:!1,actions:null,actionsHeadHtml:null,actionsFootHtml:null,showingActionTriggers:!1,_$triggers:null,$container:null,$main:null,$scroller:null,$toolbar:null,$toolbarTableRow:null,toolbarOffset:null,$selectAllContainer:null,$selectAllCheckbox:null,$search:null,searching:!1,$clearSearchBtn:null,$mainSpinner:null,$statusMenuBtn:null,statusMenu:null,status:null,$localeMenuBtn:null,localeMenu:null,locale:null,$sortMenuBtn:null,sortMenu:null,$sortAttributesList:null,$sortDirectionsList:null,$scoreSortAttribute:null,$structureSortAttribute:null,$viewModeBtnTd:null,$viewModeBtnContainer:null,viewModeBtns:null,viewMode:null,$loadingMoreSpinner:null,$sidebar:null,$sidebarButtonContainer:null,showingSidebar:null,sourceKey:null,sourceViewModes:null,$source:null,$elements:null,$table:null,$elementContainer:null,$checkboxes:null,_totalVisible:null,_morePending:!1,_totalVisiblePostStructureTableDraggee:null,_morePendingPostStructureTableDraggee:!1,loadingMore:!1,init:function(t,s,i){this.elementType=t,this.$container=s,this.setSettings(i,Ant.BaseElementIndex.defaults),this.instanceState={selectedSource:null},this.sourceStates={},this.settings.storageKey&&e.extend(this.instanceState,Ant.getLocalStorage(this.settings.storageKey),{}),this.sourceStatesStorageKey="BaseElementIndex."+this.elementType+"."+this.settings.context,e.extend(this.sourceStates,Ant.getLocalStorage(this.sourceStatesStorageKey,{})),this.$main=this.$container.find(".main"),this.$toolbar=this.$container.find(".toolbar:first"),this.$toolbarTableRow=this.$toolbar.children("table").children("tbody").children("tr"),this.$statusMenuBtn=this.$toolbarTableRow.find(".statusmenubtn:first"),this.$localeMenuBtn=this.$toolbarTableRow.find(".localemenubtn:first"),this.$sortMenuBtn=this.$toolbarTableRow.find(".sortmenubtn:first"),this.$search=this.$toolbarTableRow.find(".search:first input:first"),this.$clearSearchBtn=this.$toolbarTableRow.find(".search:first > .clear"),this.$mainSpinner=this.$toolbar.find(".spinner:first"),this.$loadingMoreSpinner=this.$container.find(".spinner.loadingmore"),this.$elements=this.$container.find(".elements:first"),this.$viewModeBtnTd=this.$toolbarTableRow.find(".viewbtns:first"),this.$viewModeBtnContainer=e('<div class="btngroup fullwidth"/>').appendTo(this.$viewModeBtnTd),this.onAfterHtmlInit(),this.initialized=!0,e.proxy(this,"onSourceSelectionChange")()},get $sources(){return this.sourceSelect?this.sourceSelect.$items:void 0},get totalVisible(){return this._isStructureTableDraggingLastElements()?this._totalVisiblePostStructureTableDraggee:this._totalVisible},get morePending(){return this._isStructureTableDraggingLastElements()?this._morePendingPostStructureTableDraggee:this._morePending},updateFixedToolbar:function(){},initSource:function(e){this.sourceSelect.addItems(e)},initSourceToggle:function(e){var t=this._getSourceToggle(e);t.length&&this.addListener(t,"click","_onToggleClick")},deinitSource:function(e){this.sourceSelect.removeItems(e),this.deinitSourceToggle(e)},deinitSourceToggle:function(e){var t=this._getSourceToggle(e);t.length&&this.removeListener(t,"click")},getDefaultSourceKey:function(){return this.instanceState.selectedSource},onSourceSelectionChange:function(){this.updateElements()},onStartSearching:function(){this.$clearSearchBtn.removeClass("hidden"),this.$scoreSortAttribute||(this.$scoreSortAttribute=e('<li><a data-attr="score">'+Ant.t("Score")+"</a></li>"),this.sortMenu.addOptions(this.$scoreSortAttribute.children())),this.$scoreSortAttribute.prependTo(this.$sortAttributesList),this.setSortAttribute("score"),this.getSortAttributeOption("structure").addClass("disabled"),this.searching=!0},onStopSearching:function(){this.$clearSearchBtn.addClass("hidden"),this.$scoreSortAttribute.detach(),this.getSortAttributeOption("structure").removeClass("disabled"),this.setStoredSortOptionsForSource(),this.searching=!1},setInstanceState:function(t,s){"object"==typeof t?e.extend(this.instanceState,t):this.instanceState[t]=s,this.settings.storageKey&&Ant.setLocalStorage(this.settings.storageKey,this.instanceState)},getSourceState:function(e,t,s){return"undefined"==typeof this.sourceStates[e]&&(this.sourceStates[e]={}),"undefined"==typeof t?this.sourceStates[e]:"undefined"!=typeof this.sourceStates[e][t]?this.sourceStates[e][t]:"undefined"!=typeof s?s:null},getSelectedSourceState:function(e,t){return this.getSourceState(this.instanceState.selectedSource,e,t)},setSelecetedSourceState:function(t,s){var i=this.getSelectedSourceState();"object"==typeof t?e.extend(i,t):i[t]=s,this.sourceStates[this.instanceState.selectedSource]=i,Ant.setLocalStorage(this.sourceStatesStorageKey,this.sourceStates)},getControllerData:function(){var t={context:this.settings.context,elementType:this.elementType,criteria:e.extend({status:this.status,locale:this.locale},this.settings.criteria),disabledElementIds:this.settings.disabledElementIds,source:this.instanceState.selectedSource,status:this.status,viewState:this.getSelectedSourceState(),search:this.$search?this.$search.val():null};return t.viewState.order=this.getSelectedSortAttribute(),t.viewState.sort=this.getSelectedSortDirection(),"table"==this.getSelectedSourceState("mode")&&"structure"==this.getSelectedSortAttribute()&&(t.collapsedElementIds=this.instanceState.collapsedElementIds),t},updateElements:function(){if(this.initialized){this.setIndexBusy(),this.removeListener(this.$scroller,"scroll"),"table"==this.getSelectedSourceState("mode")&&this.$table&&(Ant.cp.$collapsibleTables=Ant.cp.$collapsibleTables.not(this.$table));{this.getControllerData()}this.setIndexAvailable(),this._prepForNewElements(),this.selectable=this.actions||this.settings.selectable,this.$table=this.$elements,this.$elementContainer=this.getElementContainer();var t=this.$elementContainer.children();this._setupNewElements(t),"table"==this.getSelectedSourceState("mode")&&"structure"==this.getSelectedSortAttribute()&&this.addListener(this.$elementContainer,"click",function(t){var s=e(t.target);s.hasClass("toggle")&&this._collapseElement(s)===!1&&this._expandElement(s)}),"index"==this.settings.context&&this.addListener(this.$elementContainer,"dblclick",function(t){var s=e(t.target);if("A"!=s.prop("nodeName")){if(s.hasClass("element"))var i=s;else{var i=s.closest(".element");if(!i.length)return}Helper.hasAttr(i,"data-editable")&&new Ant.ElementEditor(i)}})}},showActionTriggers:function(){this.showingActionTriggers||(this.$toolbarTableRow.children().not(this.$selectAllContainer).addClass("hidden"),this._$triggers?this._$triggers.insertAfter(this.$selectAllContainer):this._createTriggers(),this.showingActionTriggers=!0)},handleActionTriggerSubmit:function(t){t.preventDefault();var s=e(t.currentTarget);if(!s.hasClass("disabled")&&!s.data("custom-handler")){var i=s.data("action"),n=Helper.getPostData(s);this.submitAction(i,n)}},handleMenuActionTriggerSubmit:function(t){var s=e(t.option);if(!s.hasClass("disabled")&&!s.data("custom-handler")){var i=s.data("action");this.submitAction(i)}},submitAction:function(t,s){var i=this.elementSelect.totalSelected,n=this.elementSelect.$items.length;if(0!=i){for(var r=0;r<this.actions.length;r++)if(this.actions[r].handle==t){var a=this.actions[r];break}if(a&&(!a.confirm||confirm(a.confirm))){var l=e.extend(this.getControllerData(),s,{elementAction:t,elementIds:this.getSelectedElementIds()});this.setIndexBusy(),Ant.postActionRequest("elementIndex/performAction",l,e.proxy(function(t,s){if(this.setIndexAvailable(),"success"==s)if(t.success){this._prepForNewElements(),this.$elementContainer.html(""),this.elementSelect=this.createElementSelect();var r=e(t.html).appendTo(this.$elementContainer);if(this._setupNewElements(r),50>=n||n>i)for(var a=0;a<l.elementIds.length;a++){var o=this.getElementById(l.elementIds[a]);o&&this.elementSelect.selectItem(o)}this._onUpdateElements(t,!1,r),t.message&&Ant.cp.displayNotice(t.message)}else Ant.cp.displayError(t.message)},this))}}},hideActionTriggers:function(){this.showingActionTriggers&&(this._$triggers.detach(),this.$toolbarTableRow.children().not(this.$selectAllContainer).removeClass("hidden"),this.showingActionTriggers=!1)},updateActionTriggers:function(){if(this.actions){var e=this.elementSelect.totalSelected;0!=e?(e==this.elementSelect.$items.length?(this.$selectAllCheckbox.removeClass("indeterminate"),this.$selectAllCheckbox.addClass("checked")):(this.$selectAllCheckbox.addClass("indeterminate"),this.$selectAllCheckbox.removeClass("checked")),this.showActionTriggers()):(this.$selectAllCheckbox.removeClass("indeterminate checked"),this.hideActionTriggers())}},maybeLoadMore:function(){this.canLoadMore()&&this.loadMore()},canLoadMore:function(){if(!this.morePending)return!1;if(this.$scroller[0]==Helper.$win[0]){var e=Helper.$win.innerHeight(),t=Helper.$win.scrollTop(),s=Helper.$bod.height();return e+t>=s}var i=this.$scroller.prop("scrollHeight"),n=this.$scroller.scrollTop(),r=this.$scroller.outerHeight();return r+15>=i-n},loadMore:function(){if(this.morePending&&!this.loadingMore){this.loadingMore=!0,this.$loadingMoreSpinner.removeClass("hidden"),this.removeListener(this.$scroller,"scroll");var t=this.getLoadMoreData();Ant.postActionRequest("elementIndex/getMoreElements",t,e.proxy(function(t,s){if(this.loadingMore=!1,this.$loadingMoreSpinner.addClass("hidden"),"success"==s){var i=e(t.html).appendTo(this.$elementContainer);(this.actions||this.settings.selectable)&&(this.elementSelect.addItems(i.filter(":not(.disabled)")),this.updateActionTriggers()),this.structureTableSort&&this.structureTableSort.addItems(i),this._onUpdateElements(t,!0,i)}},this))}},getLoadMoreData:function(){var e=this.getControllerData();return e.offset=this.totalVisible,this._isStructureTableDraggingLastElements()&&(e.criteria.positionedAfter=this.structureTableSort.$targetItem.data("id")),e},getElementContainer:function(){return this.$table.children("tbody:first")},createElementSelect:function(){return new Helper.Select(this.$elementContainer,{multi:this.actions||this.settings.multiSelect,vertical:"thumbs"!=this.getSelectedSourceState("mode"),handle:"index"==this.settings.context?".checkbox, .element":null,filter:":not(a):not(.toggle)",checkboxMode:"index"==this.settings.context&&this.actions,onSelectionChange:e.proxy(this,"onSelectionChange")})},getSelectedElementIds:function(){for(var e=this.elementSelect.$selectedItems,t=[],s=0;s<e.length;s++)t.push(e.eq(s).data("id"));return t},onUpdateElements:function(e,t){this.settings.onUpdateElements(e,t)},onStatusChange:function(t){this.statusMenu.$options.removeClass("sel");var s=e(t.selectedOption).addClass("sel");this.$statusMenuBtn.html(s.html()),this.status=s.data("status"),this.updateElements()},onLocaleChange:function(t){this.localeMenu.$options.removeClass("sel");var s=e(t.selectedOption).addClass("sel");this.$localeMenuBtn.html(s.html()),this.locale=s.data("locale"),this.initialized&&(Ant.setLocalStorage("BaseElementIndex.locale",this.locale),this.updateElements())},getSortAttributeOption:function(e){return this.$sortAttributesList.find('a[data-attr="'+e+'"]:first')},getSelectedSortAttribute:function(){},setSortAttribute:function(e){var t=this.getSortAttributeOption(e);if(t.length){this.$sortAttributesList.find("a.sel").removeClass("sel"),t.addClass("sel");var s=t.text();this.$sortMenuBtn.attr("title",Ant.t("Sort by {attribute}",{attribute:s})),this.$sortMenuBtn.text(s),this.setSortDirection("asc"),"score"==e||"structure"==e?this.$sortDirectionsList.find("a").addClass("disabled"):this.$sortDirectionsList.find("a").removeClass("disabled")}},getSortDirectionOption:function(){},getSelectedSortDirection:function(){},setSortDirection:function(e){"desc"!=e&&(e="asc"),this.$sortMenuBtn.attr("data-icon",e)},onSortChange:function(t){var s=e(t.selectedOption);if(!s.hasClass("disabled")&&!s.hasClass("sel")){s.parent().parent().is(this.$sortAttributesList)?this.setSortAttribute(s.data("attr")):this.setSortDirection(s.data("dir"));var i=this.getSelectedSortAttribute();"score"!=i&&this.setSelecetedSourceState({order:i,sort:this.getSelectedSortDirection()}),this.updateElements()}},getSourceByKey:function(e){if(this.$sources){var t=this.$sources.filter('[data-key="'+e+'"]:first');if(t.length)return t}},selectSource:function(){return!0},setStoredSortOptionsForSource:function(){this.setSortDirection("asc");var e=this.getSelectedSourceState("order"),t=this.getSelectedSourceState("sort");e&&this.setSortAttribute(e),t&&this.setSortDirection(t)},getViewModesForSource:function(){var e=[{mode:"table",title:Ant.t("Display in a table"),icon:"list"}];return Helper.hasAttr(this.$source,"data-has-thumbs")&&e.push({mode:"thumbs",title:Ant.t("Display as thumbnails"),icon:"grid"}),e},onSelectSource:function(){this.settings.onSelectSource(this.sourceKey)},onAfterHtmlInit:function(){this.settings.onAfterHtmlInit()},onSelectionChange:function(){this.updateActionTriggers(),this.settings.onSelectionChange()},doesSourceHaveViewMode:function(e){for(var t=0;t<this.sourceViewModes.length;t++)if(this.sourceViewModes[t].mode==e)return!0;return!1},selectViewMode:function(e,t){t||this.doesSourceHaveViewMode(e)||(e=this.sourceViewModes[0].mode),e!=this.viewMode&&(this.viewMode&&"undefined"!=typeof this.viewModeBtns[this.viewMode]&&this.viewModeBtns[this.viewMode].removeClass("active"),this.viewMode=e,this.setSelecetedSourceState("mode",this.viewMode),"undefined"!=typeof this.viewModeBtns[this.viewMode]&&this.viewModeBtns[this.viewMode].addClass("active"))},rememberDisabledElementId:function(t){var s=e.inArray(t,this.settings.disabledElementIds);-1==s&&this.settings.disabledElementIds.push(t)},forgetDisabledElementId:function(t){var s=e.inArray(t,this.settings.disabledElementIds);-1!=s&&this.settings.disabledElementIds.splice(s,1)},enableElements:function(t){t.removeClass("disabled").parents(".disabled").removeClass("disabled");for(var s=0;s<t.length;s++){var i=e(t[s]).data("id");this.forgetDisabledElementId(i)}this.settings.onEnableElements(t)},disableElements:function(t){t.removeClass("sel").addClass("disabled");for(var s=0;s<t.length;s++){var i=e(t[s]).data("id");this.rememberDisabledElementId(i)}this.settings.onDisableElements(t)},getElementById:function(e){return this.$elementContainer.find("[data-id="+e+"]:first")},enableElementsById:function(t){t=e.makeArray(t);for(var s=0;s<t.length;s++){var i=t[s],n=this.getElementById(i);n.length?this.enableElements(n):this.forgetDisabledElementId(i)}},disableElementsById:function(t){t=e.makeArray(t);for(var s=0;s<t.length;s++){var i=t[s],n=this.getElementById(i);n.length?this.disableElements(n):this.rememberDisabledElementId(i)}},addButton:function(t){this.showingSidebar?this.$sidebarButtonContainer.append(t):e('<td class="thin"/>').prependTo(this.$toolbarTableRow).append(t)},addCallback:function(t,s){return e.proxy(function(){"function"==typeof t&&t.apply(this,arguments),s.apply(this,arguments)},this)},setIndexBusy:function(){this.$mainSpinner.removeClass("hidden"),this.isIndexBusy=!0},setIndexAvailable:function(){this.$mainSpinner.addClass("hidden"),this.isIndexBusy=!1},disable:function(){this.sourceSelect.disable(),this.elementSelect&&this.elementSelect.disable(),this.base()},enable:function(){this.sourceSelect.enable(),this.elementSelect&&this.elementSelect.enable(),this.base()},_getSourcesInList:function(e){return e.children("li").children("a")},_getChildSources:function(e){var t=e.siblings("ul");return this._getSourcesInList(t)},_getSourceToggle:function(e){return e.siblings(".toggle")},_initSources:function(t){for(var s=0;s<t.length;s++)this.initSource(e(t[s]))},_deinitSources:function(t){for(var s=0;s<t.length;s++)this.deinitSource(e(t[s]))},_onToggleClick:function(t){this._toggleSource(e(t.currentTarget).prev("a")),t.stopPropagation()},_toggleSource:function(e){e.parent("li").hasClass("expanded")?this._collapseSource(e):this._expandSource(e)},_expandSource:function(e){e.parent("li").addClass("expanded"),this.$sidebar.trigger("resize");var t=this._getChildSources(e);this._initSources(t)},_collapseSource:function(e){e.parent("li").removeClass("expanded"),this.$sidebar.trigger("resize");var t=this._getChildSources(e);this._deinitSources(t)},_prepForNewElements:function(){this.actions&&(this.hideActionTriggers(),this._$triggers=null),this.elementSelect&&(this.elementSelect.destroy(),delete this.elementSelect),this.$selectAllContainer&&this.$selectAllContainer.detach()},_setupNewElements:function(t){this.selectable&&(this.elementSelect=this.createElementSelect(),this.elementSelect.addItems(t.filter(":not(.disabled)")),this.actions&&(this.$selectAllContainer?this.$selectAllCheckbox.removeClass("indeterminate checked"):(this.$selectAllContainer=e('<td class="selectallcontainer thin"/>'),this.$selectAllBtn=e('<div class="btn"/>').appendTo(this.$selectAllContainer),this.$selectAllCheckbox=e('<div class="checkbox"/>').appendTo(this.$selectAllBtn),this.addListener(this.$selectAllBtn,"click",function(){0==this.elementSelect.totalSelected?this.elementSelect.selectAll():this.elementSelect.deselectAll()})),this.$selectAllContainer.prependTo(this.$toolbarTableRow))),this.structureTableSort=new Ant.StructureTableSorter(this,t,{moveElementUrl:this.settings.moveElementUrl,onSortChange:e.proxy(this,"_onStructureTableSortChange")})},_onUpdateElements:function(t,s,i){e("head").append(t.headHtml),Helper.$bod.append(t.footHtml),this._isStructureTableDraggingLastElements()?(this._totalVisiblePostStructureTableDraggee=t.totalVisible,this._morePendingPostStructureTableDraggee=t.more):(this._totalVisible=t.totalVisible,this._morePending=this._morePendingPostStructureTableDraggee=t.more),this.morePending&&(this.canLoadMore()?this.loadMore():this.addListener(this.$scroller,"scroll","maybeLoadMore")),"table"==this.getSelectedSourceState("mode")&&Ant.cp.updateResponsiveTables(),this.onUpdateElements(s,i)},_collapseElement:function(e,t){if(!t&&!e.hasClass("expanded"))return!1;e.removeClass("expanded");for(var s=e.parent().parent(),i=s.data("id"),n=s.data("level"),r=s.next();r.length;){if(!Helper.hasAttr(r,"data-spinnerrow")){if(r.data("level")<=n)break;this.elementSelect&&this.elementSelect.removeItems(r),this.structureTableSort&&this.structureTableSort.removeItems(r),this._totalVisible--}var a=r.next();r.remove(),r=a}this.instanceState.collapsedElementIds||(this.instanceState.collapsedElementIds=[]),this.instanceState.collapsedElementIds.push(i),this.setInstanceState("collapsedElementIds",this.instanceState.collapsedElementIds),this.maybeLoadMore()},_expandElement:function(t,s){if(!s&&t.hasClass("expanded"))return!1;if(t.addClass("expanded"),this.instanceState.collapsedElementIds){var i=t.parent().parent(),n=i.data("id"),r=e.inArray(n,this.instanceState.collapsedElementIds);if(-1!=r){this.instanceState.collapsedElementIds.splice(r,1),this.setInstanceState("collapsedElementIds",this.instanceState.collapsedElementIds);var a=this._createSpinnerRowAfter(i),l=this.getControllerData();l.criteria.descendantOf=n,Ant.postActionRequest("elementIndex/getMoreElements",l,e.proxy(function(t,s){if(a.parent().length&&"success"==s){if(t.more){var i=a.nextAll();this.elementSelect&&this.elementSelect.removeItems(i),this.structureTableSort&&this.structureTableSort.removeItems(i),i.remove(),this._totalVisible-=i.length}else t.more=this._morePending;var n=e(t.html);a.replaceWith(n),(this.actions||this.settings.selectable)&&(this.elementSelect.addItems(n.filter(":not(.disabled)")),this.updateActionTriggers()),this.structureTableSort&&this.structureTableSort.addItems(n),t.totalVisible+=this._totalVisible,this._onUpdateElements(t,!0,n)}},this))}}},_createSpinnerRowAfter:function(t){return e('<tr data-spinnerrow><td class="centeralign" colspan="'+t.children().length+'"><div class="spinner"/></td></tr>').insertAfter(t)},_isStructureTableDraggingLastElements:function(){return this.structureTableSort&&this.structureTableSort.dragging&&this.structureTableSort.draggingLastElements},_createTriggers:function(){for(var t=[],s=[],i=[],n=0;n<this.actions.length;n++){var r=this.actions[n];if(r.trigger){var a=e('<form id="'+r.handle+'-actiontrigger"/>').data("action",r.handle).append(r.trigger);this.addListener(a,"submit","handleActionTriggerSubmit"),t.push(a)}else r.destructive?i.push(r):s.push(r)}if(s.length||i.length){var l=e("<form/>"),o=e('<div class="btn menubtn" data-icon="settings" title="'+Ant.t("Actions")+'"/>').appendTo(l),d=e('<ul class="menu"/>').appendTo(l),h=this._createMenuTriggerList(s),c=this._createMenuTriggerList(i);h&&h.appendTo(d),h&&c&&e("<hr/>").appendTo(d),c&&c.appendTo(d),t.push(l)}t.push(""),this._$triggers=e();for(var n=0;n<t.length;n++){var u=e('<td class="'+(n<t.length-1?"thin":"")+'"/>').append(t[n]);this._$triggers=this._$triggers.add(u)}this._$triggers.insertAfter(this.$selectAllContainer),e("head").append(this.actionsHeadHtml),Helper.$bod.append(this.actionsFootHtml),Ant.initUiElements(this._$triggers),o&&o.data("menubtn").on("optionSelect",e.proxy(this,"handleMenuActionTriggerSubmit"))},_createMenuTriggerList:function(t){if(t&&t.length){for(var s=e("<ul/>"),i=0;i<t.length;i++){var n=t[i].handle;e('<li><a id="'+n+'-actiontrigger" data-action="'+n+'">'+t[i].name+"</a></li>").appendTo(s)}return s}}},{defaults:{context:"index",storageKey:null,criteria:null,disabledElementIds:[],selectable:!1,multiSelect:!1,onUpdateElements:e.noop,onSelectionChange:e.noop,onEnableElements:e.noop,onDisableElements:e.noop,onSelectSource:e.noop,onAfterHtmlInit:e.noop}}),Ant.BaseElementSelectInput=Helper.Base.extend({elementSelect:null,elementSort:null,modal:null,$container:null,$elementsContainer:null,$elements:null,$addElementBtn:null,_initialized:!1,init:function(t){if(!e.isPlainObject(t)){for(var s={},i=["id","name","elementType","sources","criteria","sourceElementId","limit","modalStorageKey","fieldId"],n=0;n<i.length&&"undefined"!=typeof arguments[n];n++)s[i[n]]=arguments[n];t=s}this.setSettings(t,Ant.BaseElementSelectInput.defaults),this.settings.modalStorageKey&&(this.modalStorageKey="BaseElementSelectInput."+this.settings.modalStorageKey),1==this.settings.limit&&(this.settings.sortable=!1),this.$container=this.getContainer(),this.$elementsContainer=this.getElementsContainer(),this.$addElementBtn=this.getAddElementsBtn(),this.$addElementBtn&&1==this.settings.limit&&this.$addElementBtn.css("position","absolute").css("top",0).css(Ant.left,0),this.initElementSelect(),this.initElementSort(),this.resetElements(),this.$addElementBtn&&this.addListener(this.$addElementBtn,"activate","showModal"),this._initialized=!0},get totalSelected(){return this.$elements.length},getContainer:function(){return e("#"+this.settings.id)},getElementsContainer:function(){return this.$container.children(".elements")},getElements:function(){return this.$elementsContainer.children()},getAddElementsBtn:function(){return this.$container.children(".btn.add")},initElementSelect:function(){this.settings.selectable&&(this.elementSelect=new Helper.Select({multi:this.settings.sortable,filter:":not(.delete)"}))},initElementSort:function(){this.settings.sortable&&(this.elementSort=new Helper.DragSort({container:this.$elementsContainer,filter:this.settings.selectable?e.proxy(function(){return this.elementSort.$targetItem.hasClass("sel")?this.elementSelect.getSelectedItems():this.elementSort.$targetItem},this):null,ignoreHandleSelector:".delete",collapseDraggees:!0,magnetStrength:4,helperLagBase:1.5,onSortChange:this.settings.selectable?e.proxy(function(){this.elementSelect.resetItemOrder()},this):null}))},canAddMoreElements:function(){return!this.settings.limit||this.$elements.length<this.settings.limit},updateAddElementsBtn:function(){this.canAddMoreElements()?this.enableAddElementsBtn():this.disableAddElementsBtn()},disableAddElementsBtn:function(){this.$addElementBtn&&!this.$addElementBtn.hasClass("disabled")&&(this.$addElementBtn.addClass("disabled"),1==this.settings.limit&&(this._initialized?this.$addElementBtn.velocity("fadeOut",Ant.BaseElementSelectInput.ADD_FX_DURATION):this.$addElementBtn.hide()))},enableAddElementsBtn:function(){this.$addElementBtn&&this.$addElementBtn.hasClass("disabled")&&(this.$addElementBtn.removeClass("disabled"),1==this.settings.limit&&(this._initialized?this.$addElementBtn.velocity("fadeIn",Ant.BaseElementSelectInput.REMOVE_FX_DURATION):this.$addElementBtn.show()))},resetElements:function(){this.$elements=e(),this.addElements(this.getElements())},addElements:function(t){this.settings.selectable&&this.elementSelect.addItems(t),this.settings.sortable&&this.elementSort.addItems(t),this.settings.editable&&this.addListener(t,"dblclick",function(t){Ant.showElementEditor(e(t.currentTarget))}),t.find(".delete").on("click",e.proxy(function(t){this.removeElement(e(t.currentTarget).closest(".element"))},this)),this.$elements=this.$elements.add(t),this.updateAddElementsBtn()},removeElements:function(e){if(this.settings.selectable&&this.elementSelect.removeItems(e),this.modal){for(var t=[],s=0;s<e.length;s++){var i=e.eq(s).data("id");i&&t.push(i)}t.length&&this.modal.elementIndex.enableElementsById(t)}e.children("input").prop("disabled",!0),this.$elements=this.$elements.not(e),this.updateAddElementsBtn(),this.onRemoveElements()},removeElement:function(e){this.removeElements(e),this.animateElementAway(e,function(){e.remove()})},animateElementAway:function(e,t){e.css("z-index",0);var s={opacity:-1};s["margin-"+Ant.left]=-(e.outerWidth()+parseInt(e.css("margin-"+Ant.right))),e.velocity(s,Ant.BaseElementSelectInput.REMOVE_FX_DURATION,t)},showModal:function(){this.canAddMoreElements()&&(this.modal?this.modal.show():this.modal=this.createModal())},createModal:function(){return Ant.createElementSelectorModal(this.settings.elementType,this.getModalSettings())},getModalSettings:function(){return e.extend({storageKey:this.modalStorageKey,sources:this.settings.sources,criteria:this.settings.criteria,multiSelect:1!=this.settings.limit,disabledElementIds:this.getDisabledElementIds(),onSelect:e.proxy(this,"onModalSelect")},this.settings.modalSettings)},getSelectedElementIds:function(){for(var e=[],t=0;t<this.$elements.length;t++)e.push(this.$elements.eq(t).data("id"));
return e},getDisabledElementIds:function(){var e=this.getSelectedElementIds();return this.settings.sourceElementId&&e.push(this.settings.sourceElementId),e},onModalSelect:function(e){if(this.settings.limit){var t=this.settings.limit-this.$elements.length;e.length>t&&(e=e.slice(0,t))}this.selectElements(e),this.updateDisabledElementsInModal()},selectElements:function(e){for(var t=0;t<e.length;t++){var s=e[t],i=this.createNewElement(s);this.appendElement(i),this.addElements(i),this.animateElementIntoPlace(s.$element,i)}this.onSelectElements(e)},createNewElement:function(e){var t=e.$element.clone();return t.addClass("removable"),t.prepend('<input type="hidden" name="'+this.settings.name+'[]" value="'+e.id+'"><a class="delete icon" title="'+Ant.t("Remove")+'"></a>'),t},appendElement:function(e){e.appendTo(this.$elementsContainer)},animateElementIntoPlace:function(e,t){var s=e.offset(),i=t.offset(),n=t.clone().appendTo(Helper.$bod);t.css("visibility","hidden"),n.css({position:"absolute",zIndex:1e4,top:s.top,left:s.left});var r={top:i.top,left:i.left};n.velocity(r,Ant.BaseElementSelectInput.ADD_FX_DURATION,function(){n.remove(),t.css("visibility","visible")})},updateDisabledElementsInModal:function(){this.modal.elementIndex&&this.modal.elementIndex.disableElementsById(this.getDisabledElementIds())},getElementById:function(e){for(var t=0;t<this.$elements.length;t++){var s=this.$elements.eq(t);if(s.data("id")==e)return s}},onSelectElements:function(e){this.trigger("selectElements",{elements:e}),this.settings.onSelectElements(e)},onRemoveElements:function(){this.trigger("removeElements"),this.settings.onRemoveElements()}},{ADD_FX_DURATION:200,REMOVE_FX_DURATION:200,defaults:{id:null,name:null,fieldId:null,elementType:null,sources:null,criteria:{},sourceElementId:null,limit:null,modalStorageKey:null,modalSettings:{},onSelectElements:e.noop,onRemoveElements:e.noop,sortable:!0,selectable:!0,editable:!0}}),Ant.AdminTable=Helper.Base.extend({settings:null,totalObjects:null,sorter:null,$noObjects:null,$table:null,$tbody:null,$deleteBtns:null,init:function(t){this.setSettings(t,Ant.AdminTable.defaults),this.settings.allowDeleteAll||(this.settings.minObjects=1),this.$noObjects=e(this.settings.noObjectsSelector),this.$table=e(this.settings.tableSelector),this.$tbody=this.$table.children("tbody"),this.totalObjects=this.$tbody.children().length,this.settings.sortable&&(this.sorter=new Ant.DataTableSorter(this.$table,{onSortChange:e.proxy(this,"reorderObjects")})),this.$deleteBtns=this.$table.find(".delete"),this.addListener(this.$deleteBtns,"click","handleDeleteBtnClick"),this.updateUI()},addRow:function(t){if(!(this.settings.maxObjects&&this.totalObjects>=this.settings.maxObjects)){var s=e(t).appendTo(this.$tbody),i=s.find(".delete");this.settings.sortable&&this.sorter.addItems(s),this.$deleteBtns=this.$deleteBtns.add(i),this.addListener(i,"click","handleDeleteBtnClick"),this.totalObjects++,this.updateUI()}},reorderObjects:function(){if(!this.settings.sortable)return!1;for(var t=[],s=0;s<this.sorter.$items.length;s++){var i=e(this.sorter.$items[s]).attr(this.settings.idAttribute);t.push(i)}var n={ids:JSON.stringify(t)};Ant.postActionRequest(this.settings.reorderAction,n,e.proxy(function(e,t){"success"==t&&(e.success?Ant.cp.displayNotice(Ant.t(this.settings.reorderSuccessMessage)):Ant.cp.displayError(Ant.t(this.settings.reorderFailMessage)))},this))},handleDeleteBtnClick:function(t){if(!(this.settings.minObjects&&this.totalObjects<=this.settings.minObjects)){var s=e(t.target).closest("tr");this.confirmDeleteObject(s)&&this.deleteObject(s)}},confirmDeleteObject:function(e){var t=this.getObjectName(e);return confirm(Ant.t(this.settings.confirmDeleteMessage,{name:t}))},deleteObject:function(t){var s={id:this.getObjectId(t)};Ant.postActionRequest(this.settings.deleteAction,s,e.proxy(function(e,s){"success"==s&&this.handleDeleteObjectResponse(e,t)},this))},handleDeleteObjectResponse:function(e,t){var s=this.getObjectId(t),i=this.getObjectName(t);e.success?(t.remove(),this.totalObjects--,this.updateUI(),this.onDeleteObject(s),Ant.cp.displayNotice(Ant.t(this.settings.deleteSuccessMessage,{name:i}))):Ant.cp.displayError(Ant.t(this.settings.deleteFailMessage,{name:i}))},onDeleteObject:function(e){this.settings.onDeleteObject(e)},getObjectId:function(e){return e.attr(this.settings.idAttribute)},getObjectName:function(e){return e.attr(this.settings.nameAttribute)},updateUI:function(){if(0==this.totalObjects?(this.$table.hide(),this.$noObjects.removeClass("hidden")):(this.$table.show(),this.$noObjects.addClass("hidden")),this.settings.sortable){var t=this.$table.find(".move");1==this.totalObjects?t.addClass("disabled"):t.removeClass("disabled")}this.settings.minObjects&&this.totalObjects<=this.settings.minObjects?this.$deleteBtns.addClass("disabled"):this.$deleteBtns.removeClass("disabled"),this.settings.newObjectBtnSelector&&(this.settings.maxObjects&&this.totalObjects>=this.settings.maxObjects?e(this.settings.newObjectBtnSelector).addClass("hidden"):e(this.settings.newObjectBtnSelector).removeClass("hidden"))}},{defaults:{tableSelector:null,noObjectsSelector:null,newObjectBtnSelector:null,idAttribute:"data-id",nameAttribute:"data-name",sortable:!1,allowDeleteAll:!0,minObjects:0,maxObjects:null,reorderAction:null,deleteAction:null,reorderSuccessMessage:"New order saved.",reorderFailMessage:"Couldn’t save new order.",confirmDeleteMessage:"Are you sure you want to delete “{name}”?",deleteSuccessMessage:"“{name}” deleted.",deleteFailMessage:"Couldn’t delete “{name}”.",onDeleteObject:e.noop}}),Ant.AssetIndex=Ant.BaseElementIndex.extend({$uploadButton:null,$uploadInput:null,$progressBar:null,$folders:null,uploader:null,promptHandler:null,progressBar:null,_uploadTotalFiles:0,_uploadFileProgress:{},_uploadedFileIds:[],_currentUploaderSettings:{},_fileDrag:null,_folderDrag:null,_expandDropTargetFolderTimeout:null,_tempExpandedFolders:[],init:function(e,t,s){this.base(e,t,s),"index"==this.settings.context&&this._initIndexPageMode()},initSource:function(){},deinitSource:function(e){this.base(e);var t=e.data("contextmenu");t&&t.destroy(),"index"==this.settings.context&&(this._folderDrag&&this._getSourceLevel(e)>1&&this._folderDrag.removeItems(e.parent()),this._fileDrag&&this._fileDrag.updateDropTargets())},_getSourceLevel:function(e){return e.parentsUntil("nav","ul").length},_initIndexPageMode:function(){this.settings.selectable=!0,this.settings.multiSelect=!0;var t=e.proxy(this,"_onDragStart");onDropTargetChangeProxy=e.proxy(this,"_onDropTargetChange"),this._fileDrag=new Helper.DragDrop({activeDropTargetClass:"sel",helperOpacity:.75,filter:e.proxy(function(){return this.elementSelect.getSelectedItems()},this),helper:e.proxy(function(e){return this._getFileDragHelper(e)},this),dropTargets:e.proxy(function(){for(var t=[],s=0;s<this.$sources.length;s++)t.push(e(this.$sources[s]));return t},this),onDragStart:t,onDropTargetChange:onDropTargetChangeProxy,onDragStop:e.proxy(this,"_onFileDragStop")}),this._folderDrag=new Helper.DragDrop({activeDropTargetClass:"sel",helperOpacity:.75,filter:e.proxy(function(){for(var t=this.sourceSelect.getSelectedItems(),s=[],i=0;i<t.length;i++){var n=e(t[i]).parent();n.hasClass("sel")&&this._getSourceLevel(n)>1&&s.push(n[0])}return e(s)},this),helper:e.proxy(function(t){var s=e('<div class="sidebar" style="padding-top: 0; padding-bottom: 0;"/>'),i=e("<nav/>").appendTo(s),n=e("<ul/>").appendTo(i);return t.appendTo(n).removeClass("expanded"),t.children("a").addClass("sel"),t.css({"padding-top":this._folderDrag.$draggee.css("padding-top"),"padding-right":this._folderDrag.$draggee.css("padding-right"),"padding-bottom":this._folderDrag.$draggee.css("padding-bottom"),"padding-left":this._folderDrag.$draggee.css("padding-left")}),s},this),dropTargets:e.proxy(function(){var t=[],s=[];this._folderDrag.$draggee.find("a[data-key]").each(function(){s.push(e(this).data("key"))});for(var i=0;i<this.$sources.length;i++){var n=e(this.$sources[i]);Ant.inArray(n.data("key"),s)||t.push(n)}return t},this),onDragStart:t,onDropTargetChange:onDropTargetChangeProxy,onDragStop:e.proxy(this,"_onFolderDragStop")})},_onFileDragStop:function(){if(this._fileDrag.$activeDropTarget&&this._fileDrag.$activeDropTarget[0]!=this.$source[0]){for(var t=this.$source,s=this._getFolderIdFromSourceKey(this._fileDrag.$activeDropTarget.data("key")),i=[],n=[],r=0;r<this._fileDrag.$draggee.length;r++){var a=Ant.getElementInfo(this._fileDrag.$draggee[r]).id,l=Ant.getElementInfo(this._fileDrag.$draggee[r]).url.split("/").pop();-1!==l.indexOf("?")&&(l=l.split("?").shift()),i.push(a),n.push(l)}if(i.length){this.setIndexBusy(),this._positionProgressBar(),this.progressBar.resetProgressBar(),this.progressBar.setItemCount(i.length),this.progressBar.showProgressBar();var o=[];for(r=0;r<i.length;r++)o.push({fileId:i[r],folderId:s,fileName:n[r]});var d=e.proxy(function(n){this.promptHandler.resetPrompts();for(var r=0;r<n.length;r++){var a=n[r];a.prompt&&this.promptHandler.addPrompt(a),a.error&&alert(a.error)}this.setIndexAvailable(),this.progressBar.hideProgressBar();var l=function(){this.sourceSelect.selectItem(t),this._totalVisible-=this._fileDrag.$draggee.length;for(var n=0;n<i.length;n++)e("[data-id="+i[n]+"]").remove();this._collapseExtraExpandedFolders(s)};if(this.promptHandler.getPromptCount()){var h=e.proxy(function(e){for(var t=[],s=0;s<e.length;s++)if("cancel"!=e[s].choice)for(var i=0;i<o.length;i++)o[i].fileName==e[s].fileName&&(o[i].action=e[s].choice,t.push(o[i]));0==t.length?l.apply(this):(this.setIndexBusy(),this.progressBar.resetProgressBar(),this.progressBar.setItemCount(this.promptHandler.getPromptCount()),this.progressBar.showProgressBar(),this._moveFile(t,0,d))},this);this._fileDrag.fadeOutHelpers(),this.promptHandler.showBatchPrompts(h)}else l.apply(this),this._fileDrag.fadeOutHelpers()},this);return void this._moveFile(o,0,d)}}else this.$source.addClass("sel"),this._collapseExtraExpandedFolders();this._fileDrag.returnHelpersToDraggees()},_onFolderDragStop:function(){if(this._folderDrag.$activeDropTarget&&0==this._folderDrag.$activeDropTarget.siblings("ul").children("li").filter(this._folderDrag.$draggee).length){var t=this._getFolderIdFromSourceKey(this._folderDrag.$activeDropTarget.data("key"));this._collapseExtraExpandedFolders(t);for(var s=[],i=0;i<this._folderDrag.$draggee.length;i++){var n=this._folderDrag.$draggee.eq(i).children("a"),r=this._getFolderIdFromSourceKey(n.data("key")),a=this._getSourceByFolderId(r);this._getFolderIdFromSourceKey(this._getParentSource(a).data("key"))!=t&&s.push(r)}if(s.length){s.sort(),s.reverse(),this.setIndexBusy(),this._positionProgressBar(),this.progressBar.resetProgressBar(),this.progressBar.setItemCount(s.length),this.progressBar.showProgressBar();for(var l=[],o=[],i=0;i<s.length;i++)o.push({folderId:s[i],parentId:t});this.requestId++;var d=[],h=[],c={},u=[],g=e.proxy(function(s){this.promptHandler.resetPrompts();for(var i=0;i<s.length;i++){var n=s[i];if(n.success&&n.transferList&&n.deleteList&&n.changedFolderIds){for(var r=0;r<n.transferList.length;r++)d.push(n.transferList[r]);for(var r=0;r<n.deleteList.length;r++)h.push(n.deleteList[r]);for(var a in n.changedFolderIds)c[a]=n.changedFolderIds[a];u.push(n.removeFromTree)}n.prompt&&this.promptHandler.addPrompt(n),n.error&&alert(n.error)}if(this.promptHandler.getPromptCount()){var l=e.proxy(function(t){this.promptHandler.resetPrompts(),this.setNewElementDataHtml("");for(var s=[],i=0;i<t.length;i++)"cancel"!=t[i].choice&&(o[0].action=t[i].choice,s.push(o[0]));0==s.length?e.proxy(this,"_performActualFolderMove",d,h,c,u)():(this.setIndexBusy(),this.progressBar.resetProgressBar(),this.progressBar.setItemCount(this.promptHandler.getPromptCount()),this.progressBar.showProgressBar(),p(s,0,g))},this);this.promptHandler.showBatchPrompts(l),this.setIndexAvailable(),this.progressBar.hideProgressBar()}else e.proxy(this,"_performActualFolderMove",d,h,c,u,t)()},this),p=e.proxy(function(t,s,i){0==s&&(l=[]),Ant.postActionRequest("assets/moveFolder",t[s],e.proxy(function(e,n){s++,this.progressBar.incrementProcessedItemCount(1),this.progressBar.updateProgressBar(),"success"==n&&l.push(e),s>=t.length?i(l):p(t,s,i)},this))},this);return void p(o,0,g)}}else this.$source.addClass("sel"),this._collapseExtraExpandedFolders();this._folderDrag.returnHelpersToDraggees()},_performActualFolderMove:function(t,s,i,n,r){this.setIndexBusy(),this.progressBar.resetProgressBar(),this.progressBar.setItemCount(1),this.progressBar.showProgressBar();var a=e.proxy(function(t,s){var i=e(),n=e();for(var a in s)n=this._getSourceByFolderId(a),n=n.attr("data-key","folder:"+s[a].newId).data("key","folder:"+s[a].newId).parent(),(0==i.length||i.parents().filter(n).length>0)&&(i=n,topFolderMovedId=s[a].newId);if(0==i.length)return this.setIndexAvailable(),this.progressBar.hideProgressBar(),void this._folderDrag.returnHelpersToDraggees();var l=i.children("a"),o=i.siblings("ul, .toggle"),d=this._getParentSource(l),h=this._getSourceByFolderId(r);this._prepareParentForChildren(h),this._appendSubfolder(h,i),l.after(o),this._cleanUpTree(d),this.$sidebar.find("ul>ul, ul>.toggle").remove();for(var c=0;c<t.length;c++)Ant.postActionRequest("assets/deleteFolder",{folderId:t[c]});this.setIndexAvailable(),this.progressBar.hideProgressBar(),this._folderDrag.returnHelpersToDraggees(),this._selectSourceByFolderId(topFolderMovedId)},this);t.length>0?this._moveFile(t,0,e.proxy(function(){a(s,i,n)},this)):a(s,i,n)},_getParentSource:function(e){return this._getSourceLevel(e)>1?e.parent().parent().siblings("a"):void 0},_moveFile:function(t,s,i){0==s&&(this.responseArray=[]),Ant.postActionRequest("assets/moveFile",t[s],e.proxy(function(e,n){this.progressBar.incrementProcessedItemCount(1),this.progressBar.updateProgressBar(),"success"==n&&(this.responseArray.push(e),Ant.cp.runPendingTasks()),s++,s>=t.length?i(this.responseArray):this._moveFile(t,s,i)},this))},_selectSourceByFolderId:function(t){for(var s=this._getSourceByFolderId(t),i=s.parent().parents("li"),n=0;n<i.length;n++){var r=e(i[n]);r.hasClass("expanded")||r.children(".toggle").click()}this.sourceSelect.selectItem(s),this.$source=s,this.sourceKey=s.data("key"),this.setInstanceState("selectedSource",this.sourceKey),this.updateElements()},onAfterHtmlInit:function(){this.$uploadButton||(this.$uploadButton=e('<div class="btn submit" data-icon="upload" style="position: relative; overflow: hidden;" role="button">'+Ant.t("Upload files")+"</div>"),this.addButton(this.$uploadButton),this.$uploadInput=e('<input type="file" multiple="multiple" name="assets-upload" />').hide().insertBefore(this.$uploadButton)),this.promptHandler=new Ant.PromptHandler,this.progressBar=new Ant.ProgressBar(this.$main,!0);var t={url:Ant.getActionUrl("assets/uploadFile"),fileInput:this.$uploadInput,dropZone:this.$main};t.events={fileuploadstart:e.proxy(this,"_onUploadStart"),fileuploadprogressall:e.proxy(this,"_onUploadProgress"),fileuploaddone:e.proxy(this,"_onUploadComplete")},"undefined"!=typeof this.settings.criteria.kind&&(t.allowedKinds=this.settings.criteria.kind),this._currentUploaderSettings=t,this.uploader=new Ant.Uploader(this.$uploadButton,t),this.$uploadButton.on("click",e.proxy(function(){this.$uploadButton.hasClass("disabled")||this.isIndexBusy||this.$uploadButton.parent().find("input[name=assets-upload]").click()},this)),this.base()},onSelectSource:function(){this.uploader.setParams({folderId:this._getFolderIdFromSourceKey(this.sourceKey)}),this.$source.attr("data-upload")?this.$uploadButton.removeClass("disabled"):this.$uploadButton.addClass("disabled"),this.base()},_getFolderIdFromSourceKey:function(e){return e.split(":")[1]},_onUploadStart:function(){this.setIndexBusy(),this._positionProgressBar(),this.progressBar.resetProgressBar(),this.progressBar.showProgressBar()},_onUploadProgress:function(e,t){var s=parseInt(t.loaded/t.total*100,10);this.progressBar.setProgressPercentage(s)},_onUploadComplete:function(t,s){var i=s.result,n=s.files[0].name,r=!0;i.success||i.prompt?(this._uploadedFileIds.push(i.fileId),i.prompt&&this.promptHandler.addPrompt(i)):(alert(i.error?Ant.t("Upload failed for {filename}. The error message was: ”{error}“",{filename:n,error:i.error}):Ant.t("Upload failed for {filename}.",{filename:n})),r=!1),this.uploader.isLastUpload()&&(this.setIndexAvailable(),this.progressBar.hideProgressBar(),this.promptHandler.getPromptCount()?this.promptHandler.showBatchPrompts(e.proxy(this,"_uploadFollowup")):r&&this.updateElements())},_uploadFollowup:function(t){this.setIndexBusy(),this.progressBar.resetProgressBar(),this.promptHandler.resetPrompts();var s=e.proxy(function(){this.setIndexAvailable(),this.progressBar.hideProgressBar(),this.updateElements()},this);this.progressBar.setItemCount(t.length);var i=e.proxy(function(t,s,n){var r={newFileId:t[s].fileId,fileName:t[s].fileName,userResponse:t[s].choice};Ant.postActionRequest("assets/uploadFile",r,e.proxy(function(e,r){"success"==r&&e.fileId&&this._uploadedFileIds.push(e.fileId),s++,this.progressBar.incrementProcessedItemCount(1),this.progressBar.updateProgressBar(),s==t.length?n():i(t,s,n)},this))},this);this.progressBar.showProgressBar(),i(t,0,s)},onUpdateElements:function(e,t){if("index"==this.settings.context&&(e||this._fileDrag.removeAllItems(),this._fileDrag.addItems(t)),this._uploadedFileIds.length){for(var s=null,i=0;i<this._uploadedFileIds.length;i++)s=this.$main.find(".element[data-id="+this._uploadedFileIds[i]+"]:first").parent(),"table"==this.getSelectedSourceState("mode")&&(s=s.parent()),this.elementSelect&&this.elementSelect.selectItem(s);this._uploadedFileIds=[]}this.base(e,t)},_onDragStart:function(){this._tempExpandedFolders=[]},_getFileDragHelper:function(t){var s=this.getSelectedSourceState("mode");switch(s){case"table":var i=e('<div class="elements datatablesorthelper"/>').appendTo(Helper.$bod),n=e('<div class="tableview"/>').appendTo(i),r=e('<table class="data"/>').appendTo(n),a=e("<tbody/>").appendTo(r);t.appendTo(a),this._$firstRowCells=this.$elementContainer.children("tr:first").children();for(var l=t.children(),o=0;o<l.length;o++){var d=e(l[o]);if(Helper.hasAttr(d,"data-checkboxcell"))d.remove(),i.css("margin-"+Ant.left,19);else{var h=e(this._$firstRowCells[o]),c=h.width();h.width(c),d.width(c)}}return i;case"thumbs":var i=e('<div class="elements thumbviewhelper"/>').appendTo(Helper.$bod),n=e('<ul class="thumbsview"/>').appendTo(i);return t.appendTo(n),i}return e()},_onDropTargetChange:function(t){if(clearTimeout(this._expandDropTargetFolderTimeout),t){var s=this._getFolderIdFromSourceKey(t.data("key"));s?(this.dropTargetFolder=this._getSourceByFolderId(s),this._hasSubfolders(this.dropTargetFolder)&&!this._isExpanded(this.dropTargetFolder)&&(this._expandDropTargetFolderTimeout=setTimeout(e.proxy(this,"_expandFolder"),500))):this.dropTargetFolder=null}t&&t[0]!=this.$source[0]?this.$source.removeClass("sel"):this.$source.addClass("sel")},_collapseExtraExpandedFolders:function(e){if(clearTimeout(this._expandDropTargetFolderTimeout),e)var t=this._getSourceByFolderId(e).parents("li").children("a");for(var s=this._tempExpandedFolders.length-1;s>=0;s--){var i=this._tempExpandedFolders[s];e&&0!=t.filter('[data-key="'+i.data("key")+'"]').length||(this._collapseFolder(i),this._tempExpandedFolders.splice(s,1))}},_getSourceByFolderId:function(e){return this.$sources.filter('[data-key="folder:'+e+'"]')},_hasSubfolders:function(e){return e.siblings("ul").find("li").length},_isExpanded:function(e){return e.parent("li").hasClass("expanded")},_expandFolder:function(){this._collapseExtraExpandedFolders(this._getFolderIdFromSourceKey(this.dropTargetFolder.data("key"))),this.dropTargetFolder.siblings(".toggle").click(),this._tempExpandedFolders.push(this.dropTargetFolder)},_collapseFolder:function(e){e.parent().hasClass("expanded")&&e.siblings(".toggle").click()},_createFolderContextMenu:function(t){var s=[{label:Ant.t("New subfolder"),onClick:e.proxy(this,"_createSubfolder",t)}];"index"==this.settings.context&&this._getSourceLevel(t)>1&&(s.push({label:Ant.t("Rename folder"),onClick:e.proxy(this,"_renameFolder",t)}),s.push({label:Ant.t("Delete folder"),onClick:e.proxy(this,"_deleteFolder",t)})),new Helper.ContextMenu(t,s,{menuClass:"menu"})},_createSubfolder:function(t){var s=prompt(Ant.t("Enter the name of the folder"));if(s){var i={parentId:this._getFolderIdFromSourceKey(t.data("key")),folderName:s};this.setIndexBusy(),Ant.postActionRequest("assets/createFolder",i,e.proxy(function(s,i){if(this.setIndexAvailable(),"success"==i&&s.success){this._prepareParentForChildren(t);var n=e('<li><a data-key="folder:'+s.folderId+'"'+(Helper.hasAttr(t,"data-has-thumbs")?" data-has-thumbs":"")+' data-upload="'+t.attr("data-upload")+'">'+s.folderName+"</a></li>"),r=n.children("a:first");this._appendSubfolder(t,n),this.initSource(r)}"success"==i&&s.error&&alert(s.error)},this))}},_deleteFolder:function(t){if(confirm(Ant.t("Really delete folder “{folder}”?",{folder:e.trim(t.text())}))){var s={folderId:this._getFolderIdFromSourceKey(t.data("key"))};this.setIndexBusy(),Ant.postActionRequest("assets/deleteFolder",s,e.proxy(function(e,s){if(this.setIndexAvailable(),"success"==s&&e.success){var i=this._getParentSource(t);this.deinitSource(t),t.parent().remove(),this._cleanUpTree(i),this.$sidebar.trigger("resize")}"success"==s&&e.error&&alert(e.error)},this))}},_renameFolder:function(t){var s=e.trim(t.text()),i=prompt(Ant.t("Rename folder"),s);if(i&&i!=s){var n={folderId:this._getFolderIdFromSourceKey(t.data("key")),newName:i};this.setIndexBusy(),Ant.postActionRequest("assets/renameFolder",n,e.proxy(function(e,s){this.setIndexAvailable(),"success"==s&&e.success&&t.text(e.newName),"success"==s&&e.error&&alert(e.error)},this),"json")}},_prepareParentForChildren:function(e){this._hasSubfolders(e)||(e.parent().addClass("expanded").append('<div class="toggle"></div><ul></ul>'),this.initSourceToggle(e))},_appendSubfolder:function(t,s){for(var i=t.siblings("ul"),n=i.children("li"),r=e.trim(s.children("a:first").text()),a=!1,l=0;l<n.length;l++){var o=e(n[l]);if(e.trim(o.children("a:first").text())>r){o.before(s),a=!0;break}}a||t.siblings("ul").append(s),this.$sidebar.trigger("resize")},_cleanUpTree:function(e){null!==e&&0==e.siblings("ul").children("li").length&&(this.deinitSourceToggle(e),e.siblings("ul").remove(),e.siblings(".toggle").remove(),e.parent().removeClass("expanded"))},_positionProgressBar:function(){var t=e(),s=0;t=this.progressBar.$progressBar.closest("index"==this.settings.context?"#content":".main");var i=t.offset().top,n=Helper.$doc.scrollTop(),r=n-i,a=Helper.$win.height();s=t.height()>a?a/2-6+r:t.height()/2-6,this.progressBar.$progressBar.css({top:s})}}),Ant.registerElementIndexClass("Asset",Ant.AssetIndex),Ant.AssetSelectInput=Ant.BaseElementSelectInput.extend({requestId:0,hud:null,uploader:null,progressBar:null,init:function(){this.base.apply(this,arguments),this._attachUploader()},_attachUploader:function(){this.progressBar=new Ant.ProgressBar(e('<div class="progress-shade"></div>').appendTo(this.$container));var t={url:Ant.getActionUrl("assets/expressUpload"),dropZone:this.$container,formData:{fieldId:this.settings.fieldId,elementId:this.settings.sourceElementId}};"undefined"!=typeof Ant.csrfTokenName&&"undefined"!=typeof Ant.csrfTokenValue&&(t.formData[Ant.csrfTokenName]=Ant.csrfTokenValue),"undefined"!=typeof this.settings.criteria.kind&&(t.allowedKinds=this.settings.criteria.kind),t.canAddMoreFiles=e.proxy(this,"canAddMoreFiles"),t.events={},t.events.fileuploadstart=e.proxy(this,"_onUploadStart"),t.events.fileuploadprogressall=e.proxy(this,"_onUploadProgress"),t.events.fileuploaddone=e.proxy(this,"_onUploadComplete"),this.uploader=new Ant.Uploader(this.$container,t)},selectUploadedFile:function(e){if(this.canAddMoreElements()){var t=e.$element;t.addClass("removable"),t.prepend('<input type="hidden" name="'+this.settings.name+'[]" value="'+e.id+'"><a class="delete icon" title="'+Ant.t("Remove")+'"></a>'),t.appendTo(this.$elementsContainer);var s=-(t.outerWidth()+10);this.$addElementBtn.css("margin-"+Ant.left,s+"px");var i={};i["margin-"+Ant.left]=0,this.$addElementBtn.velocity(i,"fast"),this.addElements(t),delete this.modal}},_onUploadStart:function(){this.progressBar.$progressBar.css({top:Math.round(this.$container.outerHeight()/2)-6}),this.$container.addClass("uploading"),this.progressBar.resetProgressBar(),this.progressBar.showProgressBar()},_onUploadProgress:function(e,t){var s=parseInt(t.loaded/t.total*100,10);this.progressBar.setProgressPercentage(s)},_onUploadComplete:function(t,s){if(s.result.error)alert(s.result.error);else{var i=e(s.result.html);e("head").append(s.result.css),this.selectUploadedFile(Ant.getElementInfo(i))}this.uploader.isLastUpload()&&(this.progressBar.hideProgressBar(),this.$container.removeClass("uploading"))},canAddMoreFiles:function(e){return!this.settings.limit||this.$elements.length+e<this.settings.limit}}),function(e){Ant.AuthManager=Helper.Base.extend({checkAuthTimeoutTimer:null,showLoginModalTimer:null,decrementLogoutWarningInterval:null,showingLogoutWarningModal:!1,showingLoginModal:!1,logoutWarningModal:null,loginModal:null,$logoutWarningPara:null,$passwordInput:null,$passwordSpinner:null,$loginBtn:null,$loginErrorPara:null,init:function(){this.updateAuthTimeout(Ant.authTimeout)},setCheckAuthTimeoutTimer:function(t){this.checkAuthTimeoutTimer&&clearTimeout(this.checkAuthTimeoutTimer),this.checkAuthTimeoutTimer=setTimeout(e.proxy(this,"checkAuthTimeout"),1e3*t)},checkAuthTimeout:function(t){e.ajax({url:Ant.getActionUrl("users/getAuthTimeout",t?null:"dontExtendSession=1"),type:"GET",complete:e.proxy(function(e,t){this.updateAuthTimeout("success"!=t||isNaN(e.responseText)?-1:e.responseText)},this)})},updateAuthTimeout:function(t){this.authTimeout=parseInt(t),-1!=this.authTimeout&&this.authTimeout<Ant.AuthManager.minSafeAuthTimeout?(this.authTimeout?(this.showingLogoutWarningModal||this.showLogoutWarningModal(),this.authTimeout<Ant.AuthManager.checkInterval&&(this.showLoginModalTimer&&clearTimeout(this.showLoginModalTimer),this.showLoginModalTimer=setTimeout(e.proxy(this,"showLoginModal"),1e3*this.authTimeout))):this.showingLoginModal||this.showLoginModal(),this.setCheckAuthTimeoutTimer(Ant.AuthManager.checkInterval)):(this.hideLogoutWarningModal(),this.hideLoginModal(),this.setCheckAuthTimeoutTimer(-1!=this.authTimeout&&this.authTimeout<Ant.AuthManager.minSafeAuthTimeout+Ant.AuthManager.checkInterval?this.authTimeout-Ant.AuthManager.minSafeAuthTimeout+1:Ant.AuthManager.checkInterval))},showLogoutWarningModal:function(){if(this.showingLoginModal){this.hideLoginModal(!0);var t=!0}else var t=!1;if(this.showingLogoutWarningModal=!0,!this.logoutWarningModal){var s=e('<form id="logoutwarningmodal" class="modal alert fitted"/>'),i=e('<div class="body"/>').appendTo(s),n=e('<div class="buttons right"/>').appendTo(i),r=e('<div class="btn">'+Ant.t("Log out now")+"</div>").appendTo(n),a=e('<input type="submit" class="btn submit" value="'+Ant.t("Keep me logged in")+'" />').appendTo(n);this.$logoutWarningPara=e("<p/>").prependTo(i),this.logoutWarningModal=new Helper.Modal(s,{autoShow:!1,closeOtherModals:!1,hideOnEsc:!1,hideOnShadeClick:!1,shadeClass:"modal-shade dark",onFadeIn:function(){Helper.isMobileBrowser(!0)||setTimeout(function(){a.focus()},100)}}),this.addListener(r,"activate","logout"),this.addListener(s,"submit","renewSession")}t?this.logoutWarningModal.quickShow():this.logoutWarningModal.show(),this.updateLogoutWarningMessage(),this.decrementLogoutWarningInterval=setInterval(e.proxy(this,"decrementLogoutWarning"),1e3)},updateLogoutWarningMessage:function(){this.$logoutWarningPara.text(Ant.t("Your session will expire in {time}.",{time:Ant.secondsToHumanTimeDuration(this.authTimeout)})),this.logoutWarningModal.updateSizeAndPosition()},decrementLogoutWarning:function(){this.authTimeout>0&&(this.authTimeout--,this.updateLogoutWarningMessage()),0==this.authTimeout&&clearInterval(this.decrementLogoutWarningInterval)},hideLogoutWarningModal:function(e){this.showingLogoutWarningModal=!1,this.logoutWarningModal&&(e?this.logoutWarningModal.quickHide():this.logoutWarningModal.hide(),this.decrementLogoutWarningInterval&&clearInterval(this.decrementLogoutWarningInterval))},showLoginModal:function(){if(this.showingLogoutWarningModal){this.hideLogoutWarningModal(!0);var t=!0}else var t=!1;if(this.showingLoginModal=!0,!this.loginModal){var s=e('<form id="loginmodal" class="modal alert fitted"/>'),i=e('<div class="body"><h2>'+Ant.t("Your session has ended.")+"</h2><p>"+Ant.t("Enter your password to log back in.")+"</p></div>").appendTo(s),n=e('<div class="inputcontainer">').appendTo(i),r=e('<table class="inputs fullwidth"/>').appendTo(n),a=e("<tr/>").appendTo(r),l=e("<td/>").appendTo(a),o=e('<td class="thin"/>').appendTo(a),d=e('<div class="passwordwrapper"/>').appendTo(l);this.$passwordInput=e('<input type="password" class="text password fullwidth" placeholder="'+Ant.t("Password")+'"/>').appendTo(d),this.$passwordSpinner=e('<div class="spinner hidden"/>').appendTo(n),this.$loginBtn=e('<input type="submit" class="btn submit disabled" value="'+Ant.t("Login")+'" />').appendTo(o),this.$loginErrorPara=e('<p class="error"/>').appendTo(i),this.loginModal=new Helper.Modal(s,{autoShow:!1,closeOtherModals:!1,hideOnEsc:!1,hideOnShadeClick:!1,shadeClass:"modal-shade dark",onFadeIn:e.proxy(function(){Helper.isMobileBrowser(!0)||setTimeout(e.proxy(function(){this.$passwordInput.focus()},this),100)},this),onFadeOut:e.proxy(function(){this.$passwordInput.val("")},this)}),new Ant.PasswordInput(this.$passwordInput,{onToggleInput:e.proxy(function(e){this.$passwordInput=e},this)}),this.addListener(this.$passwordInput,"textchange","validatePassword"),this.addListener(s,"submit","login")}t?this.loginModal.quickShow():this.loginModal.show()},hideLoginModal:function(e){this.showingLoginModal=!1,this.loginModal&&(e?this.loginModal.quickHide():this.loginModal.hide())},logout:function(){var t=Ant.getActionUrl("users/logout");e.get(t,e.proxy(function(){Ant.redirectTo("")},this))},renewSession:function(e){e&&e.preventDefault(),this.hideLogoutWarningModal(),this.checkAuthTimeout(!0)},validatePassword:function(){return this.$passwordInput.val().length>=6?(this.$loginBtn.removeClass("disabled"),!0):(this.$loginBtn.addClass("disabled"),!1)},login:function(t){if(t&&t.preventDefault(),this.validatePassword()){this.$passwordSpinner.removeClass("hidden"),this.clearLoginError();var s={loginName:Ant.username,password:this.$passwordInput.val()};Ant.postActionRequest("users/login",s,e.proxy(function(e,t){this.$passwordSpinner.addClass("hidden"),"success"==t?e.success?(this.hideLoginModal(),this.checkAuthTimeout()):(this.showLoginError(e.error),Helper.shake(this.loginModal.$container),Helper.isMobileBrowser(!0)||this.$passwordInput.focus()):this.showLoginError()},this))}},showLoginError:function(e){(null===e||"undefined"==typeof e)&&(e=Ant.t("An unknown error occurred.")),this.$loginErrorPara.text(e),this.loginModal.updateSizeAndPosition()},clearLoginError:function(){this.showLoginError("")}},{checkInterval:60,minSafeAuthTimeout:120})}(jQuery),Ant.CategoryIndex=Ant.BaseElementIndex.extend({$newCategoryBtn:null,onAfterHtmlInit:function(){this.base()},getDefaultSourceKey:function(){if("index"==this.settings.context&&"undefined"!=typeof defaultGroupHandle)for(var t=0;t<this.$sources.length;t++){var s=e(this.$sources[t]);if(s.data("handle")==defaultGroupHandle)return s.data("key")}return this.base()},onSelectSource:function(){if("index"==this.settings.context){var e=this.$source.data("handle");if("undefined"!=typeof history){var t="categories";e&&(t+="/"+e)}this.$newCategoryBtn.attr("href",Ant.getUrl("categories/"+e+"/new"))}this.base()}}),Ant.registerElementIndexClass("Category",Ant.CategoryIndex),Ant.CategorySelectInput=Ant.BaseElementSelectInput.extend({setSettings:function(){this.base.apply(this,arguments),this.settings.sortable=!1},getModalSettings:function(){var e=this.base();return e.hideOnSelect=!1,e},getElements:function(){return this.$elementsContainer.find(".element")
},onModalSelect:function(t){this.modal.disable(),this.modal.disableCancelBtn(),this.modal.disableSelectBtn(),this.modal.showFooterSpinner();for(var s=this.getSelectedElementIds(),i=0;i<t.length;i++)s.push(t[i].id);var n={categoryIds:s,locale:t[0].locale,id:this.settings.id,name:this.settings.name,limit:this.settings.limit};Ant.postActionRequest("elements/getCategoriesInputHtml",n,e.proxy(function(s,i){if(this.modal.enable(),this.modal.enableCancelBtn(),this.modal.enableSelectBtn(),this.modal.hideFooterSpinner(),"success"==i){var n=e(s.html),r=n.children(".elements");this.$elementsContainer.replaceWith(r),this.$elementsContainer=r,this.resetElements();for(var a=0;a<t.length;a++){var l=t[a],o=this.getElementById(l.id);o&&this.animateElementIntoPlace(l.$element,o)}this.updateDisabledElementsInModal(),this.modal.hide(),this.onSelectElements()}},this))},removeElement:function(e){var t=e.add(e.parent().siblings("ul").find(".element"));this.removeElements(t);for(var s=0;s<t.length;s++)this._animateCategoryAway(t,s)},_animateCategoryAway:function(t,s){if(s==t.length-1)var i=e.proxy(function(){var e=t.first().parent().parent(),s=e.parent();s[0]==this.$elementsContainer[0]||e.siblings().length?e.remove():s.remove()},this);else i=null;var n=e.proxy(function(){this.animateElementAway(t.eq(s),i)},this);0==s?n():setTimeout(n,100*s)}}),Ant.DataTableSorter=Helper.DragSort.extend({$table:null,init:function(t,s){this.$table=e(t);var i=this.$table.children("tbody").children(":not(.filler)");s=e.extend({},Ant.DataTableSorter.defaults,s),s.container=this.$table.children("tbody"),s.helper=e.proxy(this,"getHelper"),s.caboose="<tr/>",s.axis=Helper.Y_AXIS,s.magnetStrength=4,s.helperLagBase=1.5,this.base(i,s)},getHelper:function(t){var s=e('<div class="'+this.settings.helperClass+'"/>').appendTo(Helper.$bod),i=e("<table/>").appendTo(s),n=e("<tbody/>").appendTo(i);t.appendTo(n),i.width(this.$table.width()),i.prop("className",this.$table.prop("className"));for(var r=this.$table.find("tr:first"),a=r.children(),l=t.children(),o=0;o<l.length;o++)e(l[o]).width(e(a[o]).width());return s}},{defaults:{handle:".move",helperClass:"datatablesorthelper"}}),function(e){Ant.DeleteUserModal=Helper.Modal.extend({id:null,userId:null,$deleteActionRadios:null,$deleteSpinner:null,currentPasswordModal:null,userSelect:null,_deleting:!1,init:function(t,s){this.id=Math.floor(1e9*Math.random()),this.userId=t,s=e.extend(Ant.DeleteUserModal.defaults,s);var i=e('<form class="modal fitted deleteusermodal" method="post" accept-charset="UTF-8">'+Ant.getCsrfInput()+'<input type="hidden" name="action" value="users/deleteUser"/>'+(Helper.isArray(this.userId)?"":'<input type="hidden" name="userId" value="'+this.userId+'"/>')+'<input type="hidden" name="redirect" value="'+(Ant.edition==Ant.Pro?"users":"dashboard")+'"/></form>').appendTo(Helper.$bod),n=e('<div class="body"><p>'+Ant.t("What do you want to do with the their content?")+'</p><div class="options"><label><input type="radio" name="contentAction" value="transfer"/> '+Ant.t("Transfer it to:")+'</label><div id="transferselect'+this.id+'" class="elementselect"><div class="elements"></div><div class="btn add icon dashed">'+Ant.t("Choose a user")+'</div></div></div><div><label><input type="radio" name="contentAction" value="delete"/> '+Ant.t("Delete it")+"</label></div></div>").appendTo(i),r=e('<div class="buttons right"/>').appendTo(n),a=e('<div class="btn">'+Ant.t("Cancel")+"</div>").appendTo(r);if(this.$deleteActionRadios=n.find("input[type=radio]"),this.$deleteSubmitBtn=e('<input type="submit" class="btn submit disabled" value="'+Ant.t(Helper.isArray(this.userId)?"Delete users":"Delete user")+'" />').appendTo(r),this.$deleteSpinner=e('<div class="spinner hidden"/>').appendTo(r),Helper.isArray(this.userId))for(var l=["and"],o=0;o<this.userId.length;o++)l.push("not "+this.userId[o]);else var l="not "+this.userId;this.userSelect=new Ant.BaseElementSelectInput({id:"transferselect"+this.id,name:"transferContentTo",elementType:"User",criteria:{id:l},limit:1,modalSettings:{closeOtherModals:!1},onSelectElements:e.proxy(function(){this.$deleteActionRadios.first().prop("checked")?this.validateDeleteInputs():this.$deleteActionRadios.first().click()},this),onRemoveElements:e.proxy(this,"validateDeleteInputs"),selectable:!1,editable:!1}),this.addListener(a,"click","hide"),this.addListener(this.$deleteActionRadios,"change","validateDeleteInputs"),this.addListener(i,"submit","handleSubmit"),this.base(i,s)},validateDeleteInputs:function(){var e=!1;return this.$deleteActionRadios.eq(0).prop("checked")?e=!!this.userSelect.totalSelected:this.$deleteActionRadios.eq(1).prop("checked")&&(e=!0),e?this.$deleteSubmitBtn.removeClass("disabled"):this.$deleteSubmitBtn.addClass("disabled"),e},handleSubmit:function(e){return this._deleting||!this.validateDeleteInputs()?void e.preventDefault():(this.$deleteSubmitBtn.addClass("active"),this.$deleteSpinner.removeClass("hidden"),this.disable(),this.userSelect.disable(),this._deleting=!0,void(this.settings.onSubmit()===!1&&e.preventDefault()))},onFadeIn:function(){Helper.isMobileBrowser(!0)||this.$deleteActionRadios.first().focus(),this.base()}},{defaults:{onSubmit:e.noop}})}(jQuery),Ant.EditableTable=Helper.Base.extend({id:null,baseName:null,columns:null,sorter:null,biggestId:-1,$table:null,$tbody:null,$addRowBtn:null,init:function(t,s,i,n){this.id=t,this.baseName=s,this.columns=i,this.setSettings(n,Ant.EditableTable.defaults),this.$table=e("#"+t),this.$tbody=this.$table.children("tbody"),this.sorter=new Ant.DataTableSorter(this.$table,{helperClass:"editabletablesorthelper",copyDraggeeInputValuesToHelper:!0});for(var r=this.$tbody.children(),a=0;a<r.length;a++)new Ant.EditableTable.Row(this,r[a]);this.$addRowBtn=this.$table.next(".add"),this.addListener(this.$addRowBtn,"activate","addRow")},addRow:function(){var t=this.settings.rowIdPrefix+(this.biggestId+1),s=Ant.EditableTable.getRowHtml(t,this.columns,this.baseName,{}),i=e(s).appendTo(this.$tbody);new Ant.EditableTable.Row(this,i),this.sorter.addItems(i),i.find("input,textarea,select").first().focus(),this.settings.onAddRow(i)}},{textualColTypes:["singleline","multiline","number"],defaults:{rowIdPrefix:"",onAddRow:e.noop,onDeleteRow:e.noop},getRowHtml:function(e,t,s,i){var n='<tr data-id="'+e+'">';for(var r in t){var a=t[r],l=s+"["+e+"]["+r+"]",o="undefined"!=typeof i[r]?i[r]:"",d=Ant.inArray(a.type,Ant.EditableTable.textualColTypes);switch(n+='<td class="'+(d?"textual":"")+" "+("undefined"!=typeof a["class"]?a["class"]:"")+'"'+("undefined"!=typeof a.width?' width="'+a.width+'"':"")+">",a.type){case"select":n+='<div class="select small"><select name="'+l+'">';var h=!1;for(var c in a.options){var u=a.options[c];if("undefined"!=typeof u.optgroup)h?n+="</optgroup>":h=!0,n+='<optgroup label="'+u.optgroup+'">';else{var g="undefined"!=typeof u.label?u.label:u,p="undefined"!=typeof u.value?u.value:c,m="undefined"!=typeof u.disabled?u.disabled:!1;n+='<option value="'+p+'"'+(p==o?" selected":"")+(m?" disabled":"")+">"+g+"</option>"}}h&&(n+="</optgroup>"),n+="</select></div>";break;case"checkbox":n+='<input type="hidden" name="'+l+'"><input type="checkbox" name="'+l+'" value="1"'+(o?" checked":"")+">";break;default:n+='<textarea name="'+l+'" rows="1">'+o+"</textarea>"}n+="</td>"}return n+='<td class="thin action"><a class="move icon" title="'+Ant.t("Reorder")+'"></a></td><td class="thin action"><a class="delete icon" title="'+Ant.t("Delete")+'"></a></td></tr>'}}),Ant.EditableTable.Row=Helper.Base.extend({table:null,id:null,niceTexts:null,$tr:null,$tds:null,$textareas:null,$deleteBtn:null,init:function(t,s){this.table=t,this.$tr=e(s),this.$tds=this.$tr.children();var i=parseInt(this.$tr.attr("data-id").substr(this.table.settings.rowIdPrefix.length));i>this.table.biggestId&&(this.table.biggestId=i),this.$textareas=e(),this.niceTexts=[];var n={},r=0;for(var a in this.table.columns){var l=this.table.columns[a];Ant.inArray(l.type,Ant.EditableTable.textualColTypes)&&($textarea=e("textarea",this.$tds[r]),this.$textareas=this.$textareas.add($textarea),this.addListener($textarea,"focus","onTextareaFocus"),this.addListener($textarea,"mousedown","ignoreNextTextareaFocus"),this.niceTexts.push(new Helper.NiceText($textarea,{onHeightChange:e.proxy(this,"onTextareaHeightChange")})),("singleline"==l.type||"number"==l.type)&&this.addListener($textarea,"keypress",{type:l.type},"validateKeypress"),n[a]=$textarea),r++}this.onTextareaHeightChange();for(var a in this.table.columns){var l=this.table.columns[a];l.autopopulate&&"undefined"!=typeof n[l.autopopulate]&&!n[a].val()&&("handle"==l.autopopulate?new Ant.HandleGenerator(n[a],n[l.autopopulate]):new Ant.BaseInputGenerator(n[a],n[l.autopopulate]))}var o=this.$tr.children().last().find(".delete");this.addListener(o,"click","deleteRow")},onTextareaFocus:function(t){this.onTextareaHeightChange();var s=e(t.currentTarget);return s.data("ignoreNextFocus")?void s.data("ignoreNextFocus",!1):void setTimeout(function(){var e=s.val();if("undefined"!=typeof s[0].setSelectionRange){var t=2*e.length;s[0].setSelectionRange(0,t)}else s.val(e)},0)},ignoreNextTextareaFocus:function(t){e.data(t.currentTarget,"ignoreNextFocus",!0)},validateKeypress:function(e){var t=e.keyCode?e.keyCode:e.charCode;e.metaKey||e.ctrlKey||t!=Helper.RETURN_KEY&&("number"!=e.data.type||Ant.inArray(t,Ant.EditableTable.Row.numericKeyCodes))||e.preventDefault()},onTextareaHeightChange:function(){for(var e=-1,t=0;t<this.niceTexts.length;t++)this.niceTexts[t].height>e&&(e=this.niceTexts[t].height);this.$textareas.css("min-height",e);var s=this.$textareas.first().parent().height();s>e&&this.$textareas.css("min-height",s)},deleteRow:function(){this.table.sorter.removeItems(this.$tr),this.$tr.remove(),this.table.settings.onDeleteRow(this.$tr)}},{numericKeyCodes:[9,8,37,38,39,40,45,91,46,190,48,49,50,51,52,53,54,55,56,57]}),function(e){Ant.ElementActionTrigger=Helper.Base.extend({maxLevels:null,newChildUrl:null,$trigger:null,$selectedItems:null,triggerEnabled:!0,init:function(t){this.setSettings(t,Ant.ElementActionTrigger.defaults),this.$trigger=e("#"+t.handle+"-actiontrigger"),this.settings.activate&&(this.$trigger.data("custom-handler",!0),"FORM"==this.$trigger.prop("nodeName")?this.addListener(this.$trigger,"submit","handleTriggerActivation"):this.addListener(this.$trigger,"click","handleTriggerActivation")),this.updateTrigger(),Ant.elementIndex.elementSelect.on("selectionChange",e.proxy(this,"updateTrigger"))},updateTrigger:function(){0!=Ant.elementIndex.elementSelect.totalSelected&&(this.validateSelection()?this.enableTrigger():this.disableTrigger())},validateSelection:function(){var e=!0;return this.$selectedItems=Ant.elementIndex.elementSelect.$selectedItems,!this.settings.batch&&this.$selectedItems.length>1?e=!1:"function"==typeof this.settings.validateSelection&&(e=this.settings.validateSelection(this.$selectedItems)),e},enableTrigger:function(){this.triggerEnabled||(this.$trigger.removeClass("disabled"),this.triggerEnabled=!0)},disableTrigger:function(){this.triggerEnabled&&(this.$trigger.addClass("disabled"),this.triggerEnabled=!1)},handleTriggerActivation:function(e){e.preventDefault(),e.stopPropagation(),this.triggerEnabled&&this.settings.activate(this.$selectedItems)}},{defaults:{handle:null,batch:!0,validateSelection:null,activate:null}})}(jQuery),Ant.ElementEditor=Helper.Base.extend({$element:null,elementId:null,locale:null,$form:null,$fieldsContainer:null,$cancelBtn:null,$saveBtn:null,$spinner:null,$localeSelect:null,$localeSpinner:null,hud:null,init:function(t){this.$element=t,this.elementId=t.data("id"),this.$element.addClass("loading");var s={elementId:this.elementId,locale:this.$element.data("locale"),includeLocales:!0};Ant.postActionRequest("elements/getEditorHtml",s,e.proxy(this,"showHud"))},showHud:function(t,s){if(this.$element.removeClass("loading"),"success"==s){var i=e();if(t.locales){var n=e('<div class="header"/>'),r=e('<div class="select"/>').appendTo(n);this.$localeSelect=e("<select/>").appendTo(r),this.$localeSpinner=e('<div class="spinner hidden"/>').appendTo(n);for(var a=0;a<t.locales.length;a++){var l=t.locales[a];e('<option value="'+l.id+'"'+(l.id==t.locale?' selected="selected"':"")+">"+l.name+"</option>").appendTo(this.$localeSelect)}this.addListener(this.$localeSelect,"change","switchLocale"),i=i.add(n)}this.$form=e("<form/>"),this.$fieldsContainer=e('<div class="fields"/>').appendTo(this.$form),this.updateForm(t);var o=e('<div class="footer"/>').appendTo(this.$form);this.$spinner=e('<div class="spinner hidden"/>').appendTo(o);var d=e('<div class="buttons right"/>').appendTo(o);this.$cancelBtn=e('<div class="btn">'+Ant.t("Cancel")+"</div>").appendTo(d),this.$saveBtn=e('<input class="btn submit" type="submit" value="'+Ant.t("Save")+'"/>').appendTo(d),i=i.add(this.$form),this.hud=new Helper.HUD(this.$element,i,{bodyClass:"body elementeditor",closeOtherHUDs:!1}),this.hud.on("hide",e.proxy(function(){delete this.hud},this)),this.addListener(this.$form,"submit","saveElement"),this.addListener(this.$cancelBtn,"click",function(){this.hud.hide()})}},switchLocale:function(){var t=this.$localeSelect.val();if(t!=this.locale){this.$localeSpinner.removeClass("hidden");var s={elementId:this.elementId,locale:t};Ant.postActionRequest("elements/getEditorHtml",s,e.proxy(function(e,t){this.$localeSpinner.addClass("hidden"),"success"==t?this.updateForm(e):this.$localeSelect.val(this.locale)},this))}},updateForm:function(e){this.locale=e.locale,this.$fieldsContainer.html(e.html),Ant.initUiElements(this.$fieldsContainer)},saveElement:function(t){t.preventDefault(),this.$spinner.removeClass("hidden");var s=this.$form.serialize();Ant.postActionRequest("elements/saveElement",s,e.proxy(function(e,t){if(this.$spinner.addClass("hidden"),"success"==t)if("success"==t&&e.success){if(this.locale==this.$element.data("locale")){var s=this.$element.find(".title"),i=s.find("a");i.length&&e.cpEditUrl?(i.attr("href",e.cpEditUrl),i.text(e.newTitle)):s.text(e.newTitle)}"undefined"!=typeof Ant.livePreview&&Ant.livePreview.updateIframe(!0),this.closeHud()}else this.updateForm(e),Helper.shake(this.hud.$hud)},this))},closeHud:function(){this.hud.hide(),delete this.hud}}),Ant.EntryIndex=Ant.BaseElementIndex.extend({$newEntryBtnGroup:null,$newEntryMenuBtn:null,newEntryLabel:null,onAfterHtmlInit:function(){this.$newEntryBtnGroup=this.$sidebar.find("> .buttons > .btngroup"),this.$newEntryBtnGroup.length&&(this.$newEntryMenuBtn=this.$newEntryBtnGroup.children(".menubtn"),this.newEntryLabel=this.$newEntryMenuBtn.text()),this.base()},getDefaultSourceKey:function(){if("index"==this.settings.context&&"undefined"!=typeof defaultSectionHandle){if("singles"==defaultSectionHandle)return"singles";for(var t=0;t<this.$sources.length;t++){var s=e(this.$sources[t]);if(s.data("handle")==defaultSectionHandle)return s.data("key")}}return this.base()},onSelectSource:function(){if("index"==this.settings.context){if("singles"==this.$source.data("key"))var t="singles";else var t=this.$source.data("handle");if("undefined"!=typeof history){var s="entries";t&&(s+="/"+t),history.replaceState({},"",Ant.getUrl(s))}this.$newEntryBtnGroup.length&&("singles"!=t&&t?(this.$newEntryBtn?this.$newEntryBtn.remove():this.$newEntryMenuBtn.removeClass("add icon").text(""),this.$newEntryBtn=e('<a class="btn submit add icon"/>').text(this.newEntryLabel).prependTo(this.$newEntryBtnGroup),this.$newEntryBtn.attr("href",Ant.getUrl("entries/"+t+"/new"))):this.$newEntryBtn&&(this.$newEntryBtn.remove(),this.$newEntryBtn=null,this.$newEntryMenuBtn.addClass("add icon").text(this.newEntryLabel)))}this.base()}}),Ant.FieldLayoutDesigner=Helper.Base.extend({$container:null,$tabContainer:null,$unusedFieldContainer:null,$newTabBtn:null,$allFields:null,tabGrid:null,unusedFieldGrid:null,tabDrag:null,fieldDrag:null,init:function(t,s){this.$container=e(t),this.setSettings(s,Ant.FieldLayoutDesigner.defaults),this.$tabContainer=this.$container.children(".fld-tabs"),this.$unusedFieldContainer=this.$container.children(".unusedfields"),this.$newTabBtn=this.$container.find("> .newtabbtn-container > .btn"),this.$allFields=this.$unusedFieldContainer.find(".fld-field"),this.tabGrid=new Ant.Grid(this.$tabContainer,Ant.FieldLayoutDesigner.gridSettings),this.unusedFieldGrid=new Ant.Grid(this.$unusedFieldContainer,Ant.FieldLayoutDesigner.gridSettings);for(var i=this.$tabContainer.children(),n=0;n<i.length;n++)this.initTab(e(i[n]));this.fieldDrag=new Ant.FieldLayoutDesigner.FieldDrag(this),this.settings.customizableTabs&&(this.tabDrag=new Ant.FieldLayoutDesigner.TabDrag(this),this.addListener(this.$newTabBtn,"activate","addTab"))},initTab:function(t){if(this.settings.customizableTabs){var s=t.find(".tabs .settings"),i=e('<div class="menu" data-align="center"/>').insertAfter(s),n=e("<ul/>").appendTo(i);e('<li><a data-action="rename">'+Ant.t("Rename")+"</a></li>").appendTo(n),e('<li><a data-action="delete">'+Ant.t("Delete")+"</a></li>").appendTo(n),new Helper.MenuBtn(s,{onOptionSelect:e.proxy(this,"onTabOptionSelect")})}for(var r=t.children(".fld-tabcontent").children(),a=0;a<r.length;a++)this.initField(e(r[a]))},initField:function(t){var s=t.find(".settings"),i=e('<div class="menu" data-align="center"/>').insertAfter(s),n=e("<ul/>").appendTo(i);t.hasClass("fld-required")?e('<li><a data-action="toggle-required">'+Ant.t("Make not required")+"</a></li>").appendTo(n):e('<li><a data-action="toggle-required">'+Ant.t("Make required")+"</a></li>").appendTo(n),e('<li><a data-action="remove">'+Ant.t("Remove")+"</a></li>").appendTo(n),new Helper.MenuBtn(s,{onOptionSelect:e.proxy(this,"onFieldOptionSelect")})},onTabOptionSelect:function(t){if(this.settings.customizableTabs){var s=e(t),i=s.data("menu").$trigger.parent().parent().parent(),n=s.data("action");switch(n){case"rename":this.renameTab(i);break;case"delete":this.deleteTab(i)}}},onFieldOptionSelect:function(t){var s=e(t),i=s.data("menu").$trigger.parent(),n=s.data("action");switch(n){case"toggle-required":this.toggleRequiredField(i,s);break;case"remove":this.removeField(i)}},renameTab:function(e){if(this.settings.customizableTabs){var t=e.find(".tabs .tab span"),s=t.text(),i=prompt(Ant.t("Give your tab a name."),s);i&&i!=s&&(t.text(i),e.find(".id-input").attr("name",this.getFieldInputName(i)))}},deleteTab:function(t){if(this.settings.customizableTabs){for(var s=t.find(".fld-field"),i=0;i<s.length;i++){var n=e(s[i]).attr("data-id");this.removeFieldById(n)}this.tabGrid.removeItems(t),this.tabDrag.removeItems(t),t.remove()}},toggleRequiredField:function(t,s){t.hasClass("fld-required")?(t.removeClass("fld-required"),t.find(".required-input").remove(),setTimeout(function(){s.text(Ant.t("Make required"))},500)):(t.addClass("fld-required"),e('<input class="required-input" type="hidden" name="'+this.settings.requiredFieldInputName+'" value="'+t.data("id")+'">').appendTo(t),setTimeout(function(){s.text(Ant.t("Make not required"))},500))},removeField:function(e){var t=e.attr("data-id");e.remove(),this.removeFieldById(t),this.tabGrid.refreshCols(!0)},removeFieldById:function(e){var t=this.$allFields.filter("[data-id="+e+"]:first"),s=t.closest(".fld-tab");t.removeClass("hidden"),s.hasClass("hidden")?(s.removeClass("hidden"),this.unusedFieldGrid.addItems(s),this.settings.customizableTabs&&this.tabDrag.addItems(s)):this.unusedFieldGrid.refreshCols(!0)},addTab:function(){if(this.settings.customizableTabs){var t=e('<div class="fld-tab"><div class="tabs"><div class="tab sel draggable"><span>Tab '+(this.tabGrid.$items.length+1)+'</span><a class="settings icon" title="'+Ant.t("Rename")+'"></a></div></div><div class="fld-tabcontent"></div></div>').appendTo(this.$tabContainer);this.tabGrid.addItems(t),this.tabDrag.addItems(t),this.initTab(t)}},getFieldInputName:function(e){return this.settings.fieldInputName.replace(/__TAB_NAME__/g,Ant.encodeUriComponent(e))}},{gridSettings:{itemSelector:".fld-tab:not(.hidden)",minColWidth:240,percentageWidths:!1,fillMode:"grid",snapToGrid:30},defaults:{customizableTabs:!0,fieldInputName:"fieldLayout[__TAB_NAME__][]",requiredFieldInputName:"requiredFields[]"}}),Ant.FieldLayoutDesigner.BaseDrag=Helper.Drag.extend({designer:null,$insertion:null,showingInsertion:!1,$caboose:null,draggingUnusedItem:!1,addToTabGrid:!1,init:function(e,t){this.designer=e;var s=this.designer.$tabContainer.find(this.itemSelector).add(this.designer.$unusedFieldContainer.find(this.itemSelector));this.base(s,t)},onDragStart:function(){this.base(),this.draggingUnusedItem=this.$draggee.hasClass("unused"),this.$insertion=this.getInsertion(),this.addCaboose(),this.$items=e().add(this.$items.add(this.$caboose)),this.addToTabGrid&&this.designer.tabGrid.addItems(this.$caboose),this.draggingUnusedItem?this.showingInsertion=!1:(this.$insertion.insertBefore(this.$draggee),this.$draggee.detach(),this.$items=e().add(this.$items.not(this.$draggee).add(this.$insertion)),this.showingInsertion=!0,this.addToTabGrid&&(this.designer.tabGrid.removeItems(this.$draggee),this.designer.tabGrid.addItems(this.$insertion))),this.setMidpoints()},addCaboose:e.noop,getItemContainer:e.noop,isItemInTabContainer:function(e){return this.getItemContainer(e)[0]==this.designer.$tabContainer[0]},setMidpoints:function(){for(var t=0;t<this.$items.length;t++){var s=e(this.$items[t]);if(this.isItemInTabContainer(s)){var i=s.offset();s.data("midpoint",{left:i.left+s.outerWidth()/2,top:i.top+s.outerHeight()/2})}}},onDrag:function(){this.draggingUnusedItem&&!Helper.hitTest(this.mouseX,this.mouseY,this.designer.$tabContainer)?this.showingInsertion&&(this.$insertion.remove(),this.$items=e().add(this.$items.not(this.$insertion)),this.showingInsertion=!1,this.addToTabGrid?this.designer.tabGrid.removeItems(this.$insertion):this.designer.tabGrid.refreshCols(!0),this.setMidpoints()):(this.onDrag._closestItem=this.getClosestItem(),this.onDrag._closestItem!=this.$insertion[0]&&(this.showingInsertion&&e.inArray(this.$insertion[0],this.$items)<e.inArray(this.onDrag._closestItem,this.$items)&&-1==e.inArray(this.onDrag._closestItem,this.$caboose)?this.$insertion.insertAfter(this.onDrag._closestItem):this.$insertion.insertBefore(this.onDrag._closestItem),this.$items=e().add(this.$items.add(this.$insertion)),this.showingInsertion=!0,this.addToTabGrid?this.designer.tabGrid.addItems(this.$insertion):this.designer.tabGrid.refreshCols(!0),this.setMidpoints())),this.base()},getClosestItem:function(){for(this.getClosestItem._closestItem=null,this.getClosestItem._closestItemMouseDiff=null,this.getClosestItem._i=0;this.getClosestItem._i<this.$items.length;this.getClosestItem._i++)this.getClosestItem._$item=e(this.$items[this.getClosestItem._i]),this.isItemInTabContainer(this.getClosestItem._$item)&&(this.getClosestItem._midpoint=this.getClosestItem._$item.data("midpoint"),this.getClosestItem._mouseDiff=Helper.getDist(this.getClosestItem._midpoint.left,this.getClosestItem._midpoint.top,this.mouseX,this.mouseY),(null===this.getClosestItem._closestItem||this.getClosestItem._mouseDiff<this.getClosestItem._closestItemMouseDiff)&&(this.getClosestItem._closestItem=this.getClosestItem._$item[0],this.getClosestItem._closestItemMouseDiff=this.getClosestItem._mouseDiff));return this.getClosestItem._closestItem},onDragStop:function(){this.showingInsertion&&(this.$insertion.replaceWith(this.$draggee),this.$items=e().add(this.$items.not(this.$insertion).add(this.$draggee)),this.addToTabGrid&&(this.designer.tabGrid.removeItems(this.$insertion),this.designer.tabGrid.addItems(this.$draggee))),this.$items=this.$items.not(this.$caboose),this.$caboose.remove(),this.addToTabGrid&&this.designer.tabGrid.removeItems(this.$caboose),this.$draggee.css({display:this.draggeeDisplay,visibility:"hidden"}),this.designer.tabGrid.refreshCols(!0),this.designer.unusedFieldGrid.refreshCols(!0),this.returnHelpersToDraggees(),this.base()}}),Ant.FieldLayoutDesigner.TabDrag=Ant.FieldLayoutDesigner.BaseDrag.extend({itemSelector:"> div.fld-tab",addToTabGrid:!0,init:function(e){var t={handle:".tab"};this.base(e,t)},addCaboose:function(){this.$caboose=e('<div class="fld-tab fld-tab-caboose"/>').appendTo(this.designer.$tabContainer)},getInsertion:function(){var t=this.$draggee.find(".tab");return e('<div class="fld-tab fld-insertion" style="height: '+this.$draggee.height()+'px;"><div class="tabs"><div class="tab sel draggable" style="width: '+t.width()+"px; height: "+t.height()+'px;"></div></div><div class="fld-tabcontent" style="height: '+this.$draggee.find(".fld-tabcontent").height()+'px;"></div></div>')},getItemContainer:function(e){return e.parent()},onDragStop:function(){if(this.draggingUnusedItem&&this.showingInsertion){var t=this.$draggee.clone().removeClass("unused"),s=t.find(".tab span").text();t.find(".fld-field").removeClass("unused"),t.find(".tabs .tab").append('<a class="settings icon" title="'+Ant.t("Edit")+'"></a>');var i=t.find(".fld-field"),n=i.filter(".hidden").remove();i=i.not(n),i.prepend('<a class="settings icon" title="'+Ant.t("Edit")+'"></a>');for(var r=0;r<i.length;r++){var a=e(i[r]),l=this.designer.getFieldInputName(s);a.append('<input class="id-input" type="hidden" name="'+l+'" value="'+a.data("id")+'">')}this.designer.fieldDrag.addItems(i),this.designer.initTab(t),this.$draggee.css({visibility:"inherit",display:"field"}).addClass("hidden"),this.$draggee.find(".fld-field").addClass("hidden"),this.$draggee=t,this.addItems(t),this.designer.tabGrid.addItems(t),this.designer.unusedFieldGrid.removeItems(this.$draggee)}this.base()}}),Ant.FieldLayoutDesigner.FieldDrag=Ant.FieldLayoutDesigner.BaseDrag.extend({itemSelector:"> div.fld-tab .fld-field",addCaboose:function(){this.$caboose=e();for(var t=this.designer.$tabContainer.children().children(".fld-tabcontent"),s=0;s<t.length;s++){var i=e('<div class="fld-tab fld-tab-caboose"/>').appendTo(t[s]);this.$caboose=this.$caboose.add(i)}},getInsertion:function(){return e('<div class="fld-field fld-insertion" style="height: '+this.$draggee.height()+'px;"/>')},getItemContainer:function(e){return e.parent().parent().parent()},onDragStop:function(){if(this.draggingUnusedItem&&this.showingInsertion){var e=this.$draggee.clone().removeClass("unused");if(e.prepend('<a class="settings icon" title="'+Ant.t("Edit")+'"></a>'),this.designer.initField(e),this.$draggee.css({visibility:"inherit",display:"field"}).addClass("hidden"),0==this.$draggee.siblings(":not(.hidden)").length){var t=this.$draggee.parent().parent();t.addClass("hidden"),this.designer.unusedFieldGrid.removeItems(t)}this.$draggee=e,this.addItems(e)}if(this.showingInsertion){var s=this.$insertion.parent().parent().find(".tab span").text(),i=this.designer.getFieldInputName(s);this.draggingUnusedItem?this.$draggee.append('<input class="id-input" type="hidden" name="'+i+'" value="'+this.$draggee.data("id")+'">'):this.$draggee.find(".id-input").attr("name",i)}this.base()}}),Ant.FieldToggle=Helper.Base.extend({$toggle:null,targetPrefix:null,targetSelector:null,reverseTargetSelector:null,_$target:null,_$reverseTarget:null,type:null,init:function(t){this.$toggle=e(t),this.$toggle.data("fieldtoggle")&&(Helper.log("Double-instantiating a field toggle on an element"),this.$toggle.data("fieldtoggle").destroy()),this.$toggle.data("fieldtoggle",this),this.type=this.getType(),"select"==this.type?this.targetPrefix=this.$toggle.attr("data-target-prefix")||"":(this.targetSelector=this.normalizeTargetSelector(this.$toggle.data("target")),this.reverseTargetSelector=this.normalizeTargetSelector(this.$toggle.data("reverse-target"))),this.findTargets(),"link"==this.type?this.addListener(this.$toggle,"click","onToggleChange"):this.addListener(this.$toggle,"change","onToggleChange")},normalizeTargetSelector:function(e){return e&&!e.match(/^[#\.]/)&&(e="#"+e),e},getType:function(){return"INPUT"==this.$toggle.prop("nodeName")&&"checkbox"==this.$toggle.attr("type").toLowerCase()?"checkbox":"SELECT"==this.$toggle.prop("nodeName")?"select":"A"==this.$toggle.prop("nodeName")?"link":"DIV"==this.$toggle.prop("nodeName")&&this.$toggle.hasClass("lightswitch")?"lightswitch":void 0},findTargets:function(){"select"==this.type?this._$target=e(this.normalizeTargetSelector(this.targetPrefix+this.getToggleVal())):(this.targetSelector&&(this._$target=e(this.targetSelector)),this.reverseTargetSelector&&(this._$reverseTarget=e(this.reverseTargetSelector)))},getToggleVal:function(){return"lightswitch"==this.type?this.$toggle.children("input").val():Helper.getInputPostVal(this.$toggle)},onToggleChange:function(){"select"==this.type?(this.hideTarget(this._$target),this.findTargets(),this.showTarget(this._$target)):(this.onToggleChange._show="link"==this.type?this.$toggle.hasClass("collapsed")||!this.$toggle.hasClass("expanded"):!!this.getToggleVal(),this.onToggleChange._show?(this.showTarget(this._$target),this.hideTarget(this._$reverseTarget)):(this.hideTarget(this._$target),this.showTarget(this._$reverseTarget)),delete this.onToggleChange._show)},showTarget:function(e){e&&e.length&&(this.showTarget._currentHeight=e.height(),e.removeClass("hidden"),"select"!=this.type&&("link"==this.type&&(this.$toggle.removeClass("collapsed"),this.$toggle.addClass("expanded")),e.height("auto"),this.showTarget._targetHeight=e.height(),e.css({height:this.showTarget._currentHeight,overflow:"hidden"}),e.velocity("stop"),e.velocity({height:this.showTarget._targetHeight},"fast",function(){e.css({height:"",overflow:""})}),delete this.showTarget._targetHeight),delete this.showTarget._currentHeight,Helper.$win.trigger("resize"))},hideTarget:function(e){e&&e.length&&("select"==this.type?e.addClass("hidden"):("link"==this.type&&(this.$toggle.removeClass("expanded"),this.$toggle.addClass("collapsed")),e.css("overflow","hidden"),e.velocity("stop"),e.velocity({height:0},"fast",function(){e.addClass("hidden")})))}}),Ant.Structure=Helper.Base.extend({id:null,$container:null,state:null,structureDrag:null,init:function(t,s,i){this.id=t,this.$container=e(s),this.setSettings(i,Ant.Structure.defaults),this.$container.data("structure")&&(Helper.log("Double-instantiating a structure on an element"),this.$container.data("structure").destroy()),this.$container.data("structure",this),this.state={},this.settings.storageKey&&e.extend(this.state,Ant.getLocalStorage(this.settings.storageKey,{})),"undefined"==typeof this.state.collapsedElementIds&&(this.state.collapsedElementIds=[]);for(var n=this.$container.find("ul").prev(".row"),r=0;r<n.length;r++){var a=e(n[r]),l=a.parent(),o=e('<div class="toggle" title="'+Ant.t("Show/hide children")+'"/>').prependTo(a);-1!=e.inArray(a.children(".element").data("id"),this.state.collapsedElementIds)&&l.addClass("collapsed"),this.initToggle(o)}this.settings.sortable&&(this.structureDrag=new Ant.StructureDrag(this,this.settings.maxLevels)),this.settings.newChildUrl&&this.initNewChildMenus(this.$container.find(".add"))},initToggle:function(t){t.click(e.proxy(function(t){var s=e(t.currentTarget).closest("li"),i=s.children(".row").find(".element:first").data("id"),n=e.inArray(i,this.state.collapsedElementIds);s.hasClass("collapsed")?(s.removeClass("collapsed"),-1!=n&&this.state.collapsedElementIds.splice(n,1)):(s.addClass("collapsed"),-1==n&&this.state.collapsedElementIds.push(i)),this.settings.storageKey&&Ant.setLocalStorage(this.settings.storageKey,this.state)},this))},initNewChildMenus:function(e){this.addListener(e,"click","onNewChildMenuClick")},onNewChildMenuClick:function(t){var s=e(t.currentTarget);if(!s.data("menubtn")){var i=s.parent().children(".element").data("id"),n=Ant.getUrl(this.settings.newChildUrl,"parentId="+i),r=(e('<div class="menu"><ul><li><a href="'+n+'">'+Ant.t("New child")+"</a></li></ul></div>").insertAfter(s),new Helper.MenuBtn(s));r.showMenu()}},getIndent:function(e){return Ant.Structure.baseIndent+(e-1)*Ant.Structure.nestedIndent},addElement:function(t){var s=e('<li data-level="1"/>').appendTo(this.$container),i=e('<div class="row" style="margin-'+Ant.left+": -"+Ant.Structure.baseIndent+"px; padding-"+Ant.left+": "+Ant.Structure.baseIndent+'px;">').appendTo(s);if(i.append(t),this.settings.sortable&&(i.append('<a class="move icon" title="'+Ant.t("Move")+'"></a>'),this.structureDrag.addItems(s)),this.settings.newChildUrl){var n=e('<a class="add icon" title="'+Ant.t("New Child")+'"></a>').appendTo(i);
this.initNewChildMenus(n)}i.css("margin-bottom",-30),i.velocity({"margin-bottom":0},"fast")},removeElement:function(t){var s=t.parent().parent();if(this.settings.sortable&&this.structureDrag.removeItems(s),!s.siblings().length)var i=s.parent();s.css("visibility","hidden").velocity({marginBottom:-s.height()},"fast",e.proxy(function(){s.remove(),"undefined"!=typeof i&&this._removeUl(i)},this))},_removeUl:function(e){e.siblings(".row").children(".toggle").remove(),e.remove()}},{baseIndent:8,nestedIndent:35,defaults:{storageKey:null,sortable:!1,newChildUrl:null,maxLevels:null}}),Ant.StructureDrag=Helper.Drag.extend({structure:null,maxLevels:null,draggeeLevel:null,$helperLi:null,$targets:null,draggeeHeight:null,init:function(t,s){this.structure=t,this.maxLevels=s,this.$insertion=e('<li class="draginsertion"/>');var i=this.structure.$container.find("li");this.base(i,{handle:".element:first, .move:first",helper:e.proxy(this,"getHelper")})},getHelper:function(t){this.$helperLi=t;var s=e('<ul class="structure draghelper"/>').append(t);return t.css("padding-"+Ant.left,this.$draggee.css("padding-"+Ant.left)),t.find(".move").removeAttr("title"),s},onDragStart:function(){this.$targets=e(),this.findTargets(this.structure.$container),this.draggeeLevel=0;var t=this.$draggee;do this.draggeeLevel++,t=t.find("> ul > li");while(t.length);this.draggeeHeight=this.$draggee.height(),this.$draggee.velocity({height:0},"fast",e.proxy(function(){this.$draggee.addClass("hidden")},this)),this.base(),this.addListener(Helper.$doc,"keydown",function(e){e.keyCode==Helper.ESC_KEY&&this.cancelDrag()})},findTargets:function(t){for(var s=t.children().not(this.$draggee),i=0;i<s.length;i++){var n=e(s[i]);this.$targets=this.$targets.add(n.children(".row")),n.hasClass("collapsed")||this.findTargets(n.children("ul"))}},onDrag:function(){for(this._.$closestTarget&&(this._.$closestTarget.removeClass("draghover"),this.$insertion.remove()),this._.$closestTarget=null,this._.closestTargetPos=null,this._.closestTargetYDiff=null,this._.closestTargetOffset=null,this._.closestTargetHeight=null,this._.i=0;this._.i<this.$targets.length&&(this._.$target=e(this.$targets[this._.i]),this._.targetOffset=this._.$target.offset(),this._.targetHeight=this._.$target.outerHeight(),this._.targetYMidpoint=this._.targetOffset.top+this._.targetHeight/2,this._.targetYDiff=Math.abs(this.mouseY-this._.targetYMidpoint),0==this._.i||this.mouseY>=this._.targetOffset.top+5&&this._.targetYDiff<this._.closestTargetYDiff);this._.i++)this._.$closestTarget=this._.$target,this._.closestTargetPos=this._.i,this._.closestTargetYDiff=this._.targetYDiff,this._.closestTargetOffset=this._.targetOffset,this._.closestTargetHeight=this._.targetHeight;if(this._.$closestTarget)if(0==this._.closestTargetPos&&this.mouseY<this._.closestTargetOffset.top+5)this.$insertion.prependTo(this.structure.$container);else if(this._.$closestTargetLi=this._.$closestTarget.parent(),this._.closestTargetLevel=this._.$closestTargetLi.data("level"),this._.closestTargetPos<this.$targets.length-1?(this._.$nextTargetLi=e(this.$targets[this._.closestTargetPos+1]).parent(),this._.nextTargetLevel=this._.$nextTargetLi.data("level")):(this._.$nextTargetLi=null,this._.nextTargetLevel=null),this._.hoveringBetweenRows=this.mouseY>=this._.closestTargetOffset.top+this._.closestTargetHeight-5,this._.$nextTargetLi&&this._.nextTargetLevel==this._.closestTargetLevel)this._.hoveringBetweenRows?(!this.maxLevels||this.maxLevels>=this._.closestTargetLevel+this.draggeeLevel-1)&&this.$insertion.insertAfter(this._.$closestTargetLi):(!this.maxLevels||this.maxLevels>=this._.closestTargetLevel+this.draggeeLevel)&&this._.$closestTarget.addClass("draghover");else if(this._.$nextTargetLi&&this._.nextTargetLevel>this._.closestTargetLevel)(!this.maxLevels||this.maxLevels>=this._.nextTargetLevel+this.draggeeLevel-1)&&(this._.hoveringBetweenRows?this.$insertion.insertBefore(this._.$nextTargetLi):(this._.$closestTarget.addClass("draghover"),this.$insertion.appendTo(this._.$closestTargetLi.children("ul"))));else if(this._.hoveringBetweenRows){for(this._.draggeeX=this.mouseX-this.targetItemMouseDiffX,"rtl"==Ant.orientation&&(this._.draggeeX+=this.$helperLi.width()),this._.$parentLis=this._.$closestTarget.parentsUntil(this.structure.$container,"li"),this._.$closestParentLi=null,this._.closestParentLiXDiff=null,this._.closestParentLevel=null,this._.i=0;this._.i<this._.$parentLis.length;this._.i++)this._.$parentLi=e(this._.$parentLis[this._.i]),this._.parentLiX=this._.$parentLi.offset().left,"rtl"==Ant.orientation&&(this._.parentLiX+=this._.$parentLi.width()),this._.parentLiXDiff=Math.abs(this._.parentLiX-this._.draggeeX),this._.parentLevel=this._.$parentLi.data("level"),(!this.maxLevels||this.maxLevels>=this._.parentLevel+this.draggeeLevel-1)&&(!this._.$closestParentLi||this._.parentLiXDiff<this._.closestParentLiXDiff&&(!this._.$nextTargetLi||this._.parentLevel>=this._.nextTargetLevel))&&(this._.$closestParentLi=this._.$parentLi,this._.closestParentLiXDiff=this._.parentLiXDiff,this._.closestParentLevel=this._.parentLevel);this._.$closestParentLi&&this.$insertion.insertAfter(this._.$closestParentLi)}else(!this.maxLevels||this.maxLevels>=this._.closestTargetLevel+this.draggeeLevel)&&this._.$closestTarget.addClass("draghover")},cancelDrag:function(){this.$insertion.remove(),this._.$closestTarget&&this._.$closestTarget.removeClass("draghover"),this.onMouseUp()},onDragStop:function(){if(this._.$closestTarget&&(this.$insertion.parent().length||this._.$closestTarget.hasClass("draghover"))){if(this.$draggee.siblings().length)var t=null;else var t=this.$draggee.parent();if(this.$insertion.parent().length){var s=this.$insertion.next().add(this.$insertion.prev());if(-1==e.inArray(this.$draggee[0],s)){this.$insertion.replaceWith(this.$draggee);var i=!0}else{this.$insertion.remove();var i=!1}}else{var n=this._.$closestTargetLi.children("ul");if(t&&n.length&&n[0]==t[0])var i=!1;else{if(n.length)this._.$closestTargetLi.hasClass("collapsed")&&this._.$closestTarget.children(".toggle").trigger("click");else{var r=e('<div class="toggle" title="'+Ant.t("Show/hide children")+'"/>').prependTo(this._.$closestTarget);this.structure.initToggle(r),n=e("<ul>").appendTo(this._.$closestTargetLi)}this.$draggee.appendTo(n);var i=!0}}if(this._.$closestTarget.removeClass("draghover"),i){t&&this.structure._removeUl(t);var a=this.$draggee.parentsUntil(this.structure.$container,"li").length+1;if(a!=this.$draggee.data("level")){if(1==this.$draggee.data("level")){var l={};l["padding-"+Ant.left]=38,this.$helperLi.velocity(l,"fast")}else if(1==a){var l={};l["padding-"+Ant.left]=Ant.Structure.baseIndent,this.$helperLi.velocity(l,"fast")}this.setLevel(this.$draggee,a)}var o=this.$draggee.children(".row").children(".element"),d={structureId:this.structure.id,elementId:o.data("id"),locale:o.data("locale"),prevId:this.$draggee.prev().children(".row").children(".element").data("id"),parentId:this.$draggee.parent("ul").parent("li").children(".row").children(".element").data("id")};Ant.postActionRequest("structures/moveElement",d,function(e,t){"success"==t&&Ant.cp.displayNotice(Ant.t("New order saved."))})}}this.$draggee.velocity("stop").removeClass("hidden").velocity({height:this.draggeeHeight},"fast",e.proxy(function(){this.$draggee.css("height","auto")},this)),this.returnHelpersToDraggees(),this.base()},setLevel:function(t,s){t.data("level",s);var i=this.structure.getIndent(s),n={};n["margin-"+Ant.left]="-"+i+"px",n["padding-"+Ant.left]=i+"px",this.$draggee.children(".row").css(n);for(var r=t.children("ul").children(),a=0;a<r.length;a++)this.setLevel(e(r[a]),s+1)}}),Ant.StructureTableSorter=Helper.DragSort.extend({elementIndex:null,structureId:null,maxLevels:null,_helperMargin:null,_$firstRowCells:null,_$titleHelperCell:null,_titleHelperCellOuterWidth:null,_ancestors:null,_updateAncestorsFrame:null,_updateAncestorsProxy:null,_draggeeLevel:null,_draggeeLevelDelta:null,draggingLastElements:null,_loadingDraggeeLevelDelta:!1,_targetLevel:null,_targetLevelBounds:null,_positionChanged:null,init:function(t,s,i){this.elementIndex=t,this.structureId=e("#settings-grid").data("structure-id"),this.maxLevels=parseInt(this.elementIndex.$table.attr("data-max-levels")),i=e.extend({},Ant.StructureTableSorter.defaults,i,{handle:".move",collapseDraggees:!0,singleHelper:!0,helperSpacingY:2,magnetStrength:4,helper:e.proxy(this,"getHelper"),helperLagBase:1.5,axis:Helper.Y_AXIS}),this.base(s,i);var n=this;s.each(function(){var t=e(this).data("level"),s=Ant.StructureTableSorter.BASE_PADDING+(n.elementIndex.actions?14:0)+n._getLevelIndent(t);e(this).children("[data-titlecell]:first").css("padding-"+Ant.left,s)})},startDragging:function(){this._helperMargin=Ant.StructureTableSorter.HELPER_MARGIN+(this.elementIndex.actions?24:0),this.base()},findDraggee:function(){this._draggeeLevel=this._targetLevel=this.$targetItem.data("level"),this._draggeeLevelDelta=0;for(var t=e(this.$targetItem),s=this.$targetItem.next();s.length;){var i=s.data("level");if(i<=this._draggeeLevel)break;var n=i-this._draggeeLevel;n>this._draggeeLevelDelta&&(this._draggeeLevelDelta=n),t=t.add(s),s=s.next()}if(this.draggingLastElements=!s.length,this.maxLevels&&this.draggingLastElements&&this.elementIndex.morePending){this._loadingDraggeeLevelDelta=!0;var r=this._getAjaxBaseData(this.$targetItem);Ant.postActionRequest("structures/getElementLevelDelta",r,e.proxy(function(e,t){"success"==t&&(this._loadingDraggeeLevelDelta=!1,this.dragging&&(this._draggeeLevelDelta=e.delta,this.drag(!1)))},this))}return t},getHelper:function(t){var s=e('<div class="elements datatablesorthelper"/>').appendTo(Helper.$bod),i=e('<div class="tableview"/>').appendTo(s),n=e('<table class="data"/>').appendTo(i),r=e("<tbody/>").appendTo(n);t.appendTo(r),this._$firstRowCells=this.elementIndex.$elementContainer.children("tr:first").children();for(var a=t.children(),l=0;l<a.length;l++){var o=e(a[l]);if(Helper.hasAttr(o,"data-checkboxcell"))o.remove();else{var d=e(this._$firstRowCells[l]),h=d.width();if(d.width(h),o.width(h),Helper.hasAttr(d,"data-titlecell")){this._$titleHelperCell=o;var c=parseInt(d.css("padding-"+Ant.left));this._titleHelperCellOuterWidth=h+c-(this.elementIndex.actions?12:0),o.css("padding-"+Ant.left,Ant.StructureTableSorter.BASE_PADDING)}}}return s},canInsertBefore:function(e){return this._loadingDraggeeLevelDelta?!1:this._getLevelBounds(e.prev(),e)!==!1},canInsertAfter:function(e){return this._loadingDraggeeLevelDelta?!1:this._getLevelBounds(e,e.next())!==!1},onDragStart:function(){this._ancestors=this._getAncestors(this.$targetItem,this.$targetItem.data("level")),this._setTargetLevelBounds(),this.elementIndex.maybeLoadMore(),this.base()},onDrag:function(){this.base(),this._updateIndent()},onInsertionPointChange:function(){this._setTargetLevelBounds(),this._updateAncestorsBeforeRepaint(),this.base()},onDragStop:function(){if(this._positionChanged=!1,this.base(),this._targetLevel!=this._draggeeLevel){for(var t=this._targetLevel-this._draggeeLevel,s=0;s<this.$draggee.length;s++){var i=e(this.$draggee[s]),n=i.data("level"),r=n+t,a=Ant.StructureTableSorter.BASE_PADDING+(this.elementIndex.actions?14:0)+this._getLevelIndent(r);i.data("level",r),i.find(".element").data("level",r),i.children("[data-titlecell]:first").css("padding-"+Ant.left,a)}this._positionChanged=!0}if(this._positionChanged){for(var l=this._getAjaxBaseData(this.$draggee),o=this.$draggee.first().prev();o.length;){var d=o.data("level");if(d==this._targetLevel){l.prevId=o.data("id");break}if(d<this._targetLevel){l.parentId=o.data("id");var h=o.find("> td > .toggle");if(!h.hasClass("expanded")){h.addClass("expanded");var c=this.elementIndex._createSpinnerRowAfter(o)}break}o=o.prev()}var u=this;e.ajax({data:l,url:this.settings.moveElementUrl,success:function(e,t){"success"==t&&(u.onPositionChange(),c&&c.parent().length&&(c.remove(),u.elementIndex._expandElement(h,!0)))}})}},onSortChange:function(){this.elementIndex.elementSelect&&this.elementIndex.elementSelect.resetItemOrder(),this._positionChanged=!0,this.base()},onPositionChange:function(){Helper.requestAnimationFrame(e.proxy(function(){this.trigger("positionChange"),this.settings.onPositionChange()},this))},onReturnHelpersToDraggees:function(){if(this._$firstRowCells.css("width",""),this.draggingLastElements&&this.elementIndex.morePending){this.elementIndex._totalVisible+=this.newDraggeeIndexes[0]-this.oldDraggeeIndexes[0];var e=this.$draggee.last().nextAll();e.length&&(this.removeItems(e),e.remove(),this.elementIndex.maybeLoadMore())}this.base()},_getLevelBounds:function(e,t){if(this._getLevelBounds._minLevel=t&&t.length?t.data("level"):1,this._getLevelBounds._maxLevel=e&&e.length?e.data("level")+1:1,this.maxLevels){if(1!=this._getLevelBounds._minLevel&&this._getLevelBounds._minLevel+this._draggeeLevelDelta>this.maxLevels)return!1;this._getLevelBounds._maxLevel+this._draggeeLevelDelta>this.maxLevels&&(this._getLevelBounds._maxLevel=this.maxLevels-this._draggeeLevelDelta,this._getLevelBounds._maxLevel<this._getLevelBounds._minLevel&&(this._getLevelBounds._maxLevel=this._getLevelBounds._minLevel))}return{min:this._getLevelBounds._minLevel,max:this._getLevelBounds._maxLevel}},_setTargetLevelBounds:function(){this._targetLevelBounds=this._getLevelBounds(this.$draggee.first().prev(),this.$draggee.last().next())},_updateIndent:function(){this._updateIndent._mouseDist=this.realMouseX-this.mousedownX,"rtl"==Ant.orientation&&(this._updateIndent._mouseDist*=-1),this._updateIndent._indentationDist=Math.round(this._updateIndent._mouseDist/Ant.StructureTableSorter.LEVEL_INDENT),this._updateIndent._targetLevel=this._draggeeLevel+this._updateIndent._indentationDist,this._updateIndent._targetLevel<this._targetLevelBounds.min?(this._updateIndent._indentationDist+=this._targetLevelBounds.min-this._updateIndent._targetLevel,this._updateIndent._targetLevel=this._targetLevelBounds.min):this._updateIndent._targetLevel>this._targetLevelBounds.max&&(this._updateIndent._indentationDist-=this._updateIndent._targetLevel-this._targetLevelBounds.max,this._updateIndent._targetLevel=this._targetLevelBounds.max),this._targetLevel!==(this._targetLevel=this._updateIndent._targetLevel)&&this._updateAncestorsBeforeRepaint(),this._updateIndent._targetLevelMouseDiff=this._updateIndent._mouseDist-this._updateIndent._indentationDist*Ant.StructureTableSorter.LEVEL_INDENT,this._updateIndent._magnetImpact=Math.round(this._updateIndent._targetLevelMouseDiff/15),Math.abs(this._updateIndent._magnetImpact)>Ant.StructureTableSorter.MAX_GIVE&&(this._updateIndent._magnetImpact=(this._updateIndent._magnetImpact>0?1:-1)*Ant.StructureTableSorter.MAX_GIVE),this._updateIndent._closestLevelMagnetIndent=this._getLevelIndent(this._targetLevel)+this._updateIndent._magnetImpact,this.helpers[0].css("margin-"+Ant.left,this._updateIndent._closestLevelMagnetIndent+this._helperMargin),this._$titleHelperCell.width(this._titleHelperCellOuterWidth-(this._updateIndent._closestLevelMagnetIndent+Ant.StructureTableSorter.BASE_PADDING))},_getLevelIndent:function(e){return(e-1)*Ant.StructureTableSorter.LEVEL_INDENT},_getAjaxBaseData:function(e){return{structureId:this.structureId,contentId:e.data("id")}},_getAncestors:function(e,t){if(this._getAncestors._ancestors=[],0!=t)for(this._getAncestors._level=t,this._getAncestors._$prevRow=e.prev();this._getAncestors._$prevRow.length&&!(this._getAncestors._$prevRow.data("level")<this._getAncestors._level&&(this._getAncestors._ancestors.unshift(this._getAncestors._$prevRow),this._getAncestors._level=this._getAncestors._$prevRow.data("level"),0==this._getAncestors._level));)this._getAncestors._$prevRow=this._getAncestors._$prevRow.prev();return this._getAncestors._ancestors},_updateAncestorsBeforeRepaint:function(){this._updateAncestorsFrame&&Helper.cancelAnimationFrame(this._updateAncestorsFrame),this._updateAncestorsProxy||(this._updateAncestorsProxy=e.proxy(this,"_updateAncestors")),this._updateAncestorsFrame=Helper.requestAnimationFrame(this._updateAncestorsProxy)},_updateAncestors:function(){for(this._updateAncestorsFrame=null,this._updateAncestors._i=0;this._updateAncestors._i<this._ancestors.length;this._updateAncestors._i++)this._updateAncestors._$ancestor=this._ancestors[this._updateAncestors._i],this._updateAncestors._$ancestor.data("descendants",this._updateAncestors._$ancestor.data("descendants")-1),0==this._updateAncestors._$ancestor.data("descendants")&&this._updateAncestors._$ancestor.find("> td > .toggle:first").remove();for(this._updateAncestors._newAncestors=this._getAncestors(this.$targetItem,this._targetLevel),this._updateAncestors._i=0;this._updateAncestors._i<this._updateAncestors._newAncestors.length;this._updateAncestors._i++)this._updateAncestors._$ancestor=this._updateAncestors._newAncestors[this._updateAncestors._i],this._updateAncestors._$ancestor.data("descendants",this._updateAncestors._$ancestor.data("descendants")+1),1==this._updateAncestors._$ancestor.data("descendants")&&e('<span class="toggle expanded" title="'+Ant.t("Show/hide children")+'"></span>').insertAfter(this._updateAncestors._$ancestor.find("> td .move:first"));this._ancestors=this._updateAncestors._newAncestors,delete this._updateAncestors._i,delete this._updateAncestors._$ancestor,delete this._updateAncestors._newAncestors}},{BASE_PADDING:10,HELPER_MARGIN:-7,LEVEL_INDENT:44,MAX_GIVE:22,defaults:{onPositionChange:e.noop}})}(jQuery);